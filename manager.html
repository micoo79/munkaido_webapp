<!-- manager.html -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Admin KultÓra</title>

  <link rel="manifest" href="/manifest.webmanifest?v=1" />
  <meta name="theme-color" content="#27272a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VMKK KultÓra" />

  <link rel="icon" type="image/png" href="/kult_logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=1" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png?v=1" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png?v=1" />

  <!-- ✅ Material Symbols (article ikonhoz) -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#52525b;
      --zold:#1ecb5b;
      --piros:#ff3b30;

      --border:#3f3f46;
      --card:#2f2f33;

      --pillAdmin:#7c3aed;
      --pillMgr:#2563eb;

      --cellVBorder: rgba(255,255,255,.10);

      /* ✅ Summary oszlopszélességek %-ban (összeg = 100%) */
      --sumColName: 22%;
      --sumColBal: 24%;
      --sumColVac: 14%;
      --sumColSick: 12%;
      --sumColMissing: 18%;
      --sumColAction: 10%;
    }
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    a{color:var(--text); text-decoration:none;}
    .wrap{max-width:1100px; margin:0 auto; padding:14px 16px 28px;}

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:8px 0 12px;
    }
    .topbarLeft{display:flex; align-items:center; gap:10px; min-width:0;}
    .title{font-size:22px; font-weight:900;}
    .who{font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60vw;}

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      background:var(--border);
      color:var(--text);
      transition:background .15s, transform .05s;
      user-select:none;
    }
    .btn:hover{background:#52525b;}
    .btn:active{transform:scale(.98);}
    .btn.primary{background:var(--accent); color:#111;}
    .btn.ghost{background:transparent; border:1px solid var(--border);}
    .btn.small{padding:8px 10px; font-size:13px; border-radius:10px;}

    .tabs{display:flex; gap:8px; flex-wrap:wrap;}
    .tab{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{background:#3f3f46;}

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin-top:12px;
    }
    .hidden{display:none !important;}

    /* ✅ általános muted osztály (span/div esetén is) */
    .muted{ color: var(--muted); font-weight:800; }

    /* --- TEAM SUMMARY --- */
    .summaryCard{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      margin:0 0 12px 0;
    }
    .summaryHead{
      display:flex; align-items:center; justify-content:flex-end; gap:10px; flex-wrap:wrap;
      padding:6px 4px 10px;
    }
    .summaryWrap{overflow:visible;}

    table.summaryTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .summaryTable th, .summaryTable td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      vertical-align:middle;
      border-right:1px solid var(--cellVBorder);

      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:0;
    }
    .summaryTable th:last-child, .summaryTable td:last-child{ border-right:0; }

    /* ✅ fejlécben sortörés engedélyezése (minden th) */
    .summaryTable th{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.02em;
      background:var(--panel);

      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.15;
      overflow-wrap:anywhere;
      word-break:break-word;
      hyphens:auto;
    }

    .summaryTable td{
      font-size:13px;
      font-weight:800;
    }
    .summaryTable td.muted{color:var(--muted); font-weight:800;}

    /* ✅ ha egy cellában több soros szöveg kell (pl. szabadság mondatok) */
    .summaryTable td.wrapCell{
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      max-width:none;
      line-height:1.2;
    }

    .summaryTag{
      display:inline-flex; align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      margin-left:8px;
    }
    .pos{ color: var(--zold); }
    .neg{ color: var(--piros); }

    /* ✅ Summary action ikon gomb (article + "Táblázat") */
    .sumIconBtn{
      border:0;
      background:transparent;
      color:var(--text);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:2px;
      padding:2px 6px;
      width:72px;
      -webkit-tap-highlight-color:transparent;
    }
    .sumIconBtn:hover .material-symbols-outlined,
    .sumIconBtn:hover .sumIconLabel{ color:var(--accent); }
    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      line-height:1;
      transition:color .15s ease;
    }
    .sumIconLabel{
      font-size:10px;
      font-weight:900;
      color:var(--text);
      line-height:1;
      transition:color .15s ease;
      white-space:nowrap;
    }

    /* --- USERS --- */
    .gridUsers{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:900px){ .gridUsers{grid-template-columns:1fr;} }

    .panelHead{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:6px 4px 10px;}
    .panelHead h2{margin:0; font-size:16px; font-weight:900;}

    .list{display:flex; flex-direction:column; gap:10px;}
    .userCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .userMeta{min-width:0;}
    .userNameRow{display:flex; align-items:center; gap:8px; min-width:0;}
    .userName{
      font-size:15px; font-weight:900;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .userEmail{
      font-size:13px; color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      color:#fff;
      flex:0 0 auto;
    }
    .pill.admin{background:var(--pillAdmin);}
    .pill.manager{background:var(--pillMgr);}
    .actions{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}

    label{display:block; font-size:13px; color:var(--muted); margin:32px 0 6px;}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      font-size:14px;
      outline:none;
    }
    textarea{min-height:90px; resize:none;}
    .row2{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media (max-width:520px){ .row2{grid-template-columns:1fr;} }

    .radioRow{
      display:flex; gap:14px; flex-wrap:wrap;
      align-items:center;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#c9cbd1;
      color:#111;
    }
    .radioRow label{
      margin:0;
      color:#111;
      font-size:14px;
      font-weight:900;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .radioRow input[type="radio"]{
      width:18px; height:18px;
      accent-color: var(--accent);
    }

    /* --- YEAR CALENDAR --- */
    .yearHeader{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:6px 4px 12px;
    }
    .yearTitle{font-size:18px; font-weight:900;}
    .monthsGrid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width:980px){ .monthsGrid{grid-template-columns:repeat(2, 1fr);} }
    @media (max-width:620px){ .monthsGrid{grid-template-columns:1fr;} }

    .monthCard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
    }
    .monthName{font-size:15px; font-weight:900; margin:0 0 8px 0;}
    .dowMini{
      display:grid; grid-template-columns:repeat(7, 1fr);
      gap:6px;
      margin-bottom:6px;
      color:var(--muted);
      font-size:11px;
      font-weight:900;
      text-align:center;
    }
    .miniGrid{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      grid-template-rows:repeat(6, 1fr);
      gap:6px;
    }
    .miniTile{
      border-radius:10px;
      padding:6px 6px;
      min-height:34px;
      display:flex; align-items:flex-start; justify-content:flex-start;
      cursor:pointer;
      background:var(--work);
      border:0;
      overflow:hidden;
      position:relative;
    }
    .miniTile.rest{background:var(--rest);}
    .miniTile.weekend{background:var(--weekend);}
    .miniTile.holiday{background:var(--holiday);}
    .miniTile.workSaturday{background:var(--work); border:2px solid var(--zold);}

    .miniDay{
      font-size:12px;
      font-weight:900;
      line-height:1;
      color:#111;
    }
    .miniTile.weekend .miniDay,
    .miniTile.rest .miniDay{ color:#fff; }

    .miniHint{
      position:absolute;
      left:6px; right:6px; bottom:5px;
      font-size:10px;
      font-weight:900;
      color:#111;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.9;
    }

    /* --- ENTRIES VIEW --- */
    .entriesHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:6px 4px 10px;
    }
    .entriesTitle{font-size:16px; font-weight:900; margin:0;}
    .entriesMeta{font-size:13px; color:var(--muted); font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80vw;}
    .entriesWrap{overflow:visible;}

    table.entriesTable{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }

    .entriesTable th, .entriesTable td{
      padding:8px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      vertical-align:middle;

      border-right:1px solid var(--cellVBorder);

      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:0;
    }
    .entriesTable th:last-child, .entriesTable td:last-child{ border-right:0; }

    /* ✅ fejlécben sortörés engedélyezése */
    .entriesTable th{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.02em;

      position:sticky;
      top:0;
      z-index:50;
      background:var(--panel);
      box-shadow: 0 2px 0 rgba(255,255,255,.06);

      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.15;
      overflow-wrap:anywhere;
      word-break:break-word;
      hyphens:auto;
    }
    .entriesTable td{
      font-size:13px;
      font-weight:800;
    }
    .entriesTable td.muted{color:var(--muted); font-weight:800;}
    .entriesTable td.noteCell{white-space:nowrap;}

    .vacPill{
      display:inline-flex; align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:rgba(185,217,255,.18);
      border:1px solid rgba(185,217,255,.35);
      color:var(--text);
      margin-right:6px;
    }
    .sickPill{
      display:inline-flex; align-items:center;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      background:rgba(30,203,91,.18);
      border:1px solid rgba(30,203,91,.40);
      color:var(--text);
    }

    /* MODAL */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.55); display:flex; align-items:center; justify-content:center; padding:16px; z-index:60;}
    .modal{
      width:min(920px,100%);
      background:#52525b;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      padding:14px;
    }
    .modalHead{display:flex; align-items:flex-start; justify-content:space-between; gap:12px;}
    .modalTitle{margin:0; font-size:18px; font-weight:900;}
    .modalBtns{display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;}
    .hr{height:1px; background:rgba(255,255,255,.12); margin:12px 0;}
    .note{font-size:12px; color:rgba(255,255,255,.85); margin-top:8px;}

    .chkRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:12px;
      background:#fff;
      color:#111;
      border:1px solid var(--border);
    }
    .chkRow .left{font-weight:900;}
    .chkRow input[type="checkbox"]{
      width:22px; height:22px; accent-color: var(--accent);
    }

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:18px;
      z-index:99;
      font-weight:900;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- ✅ ZIP exporthoz -->
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="topbarLeft">
        <a class="btn ghost" href="/app.html">← Naptár</a>
        <div style="min-width:0;">
          <div class="title">Manager felület</div>
          <div id="who" class="who">—</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="refreshBtn" class="btn" type="button">Frissítés</button>
        <button id="logoutBtn" class="btn" type="button">Kijelentkezés</button>
      </div>
    </div>

    <div id="tabsRow" class="tabs">
      <button id="tabUsers" class="tab active" type="button">Felhasználók</button>
      <button id="tabYear" class="tab" type="button">Éves munkarend</button>
    </div>

    <!-- USERS VIEW -->
    <section id="usersView" class="panel">
      <section class="summaryCard">
        <div class="summaryHead">
          <div class="who" id="sumMeta">—</div>
        </div>

        <div class="summaryWrap">
          <table class="summaryTable">
            <colgroup>
              <col style="width:var(--sumColName)">
              <col style="width:var(--sumColBal)">
              <col style="width:var(--sumColVac)">
              <col style="width:var(--sumColSick)">
              <col style="width:var(--sumColMissing)">
              <col style="width:var(--sumColAction)">
            </colgroup>
            <thead>
              <tr>
                <th>Név</th>
                <th>Túlóra / hátralék</th>
                <th>Hátralévő szabadságok</th>
                <th>Betegállomány</th>
                <th>2 hétnél régebbi hiányzó rögzítések</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="teamTbody">
              <tr><td colspan="6" class="muted">Betöltés…</td></tr>
            </tbody>
          </table>
        </div>

         <!-- ✅ Alul jobbra: minden felhasználó export (kisebb gomb) -->
      <div style="margin-top:14px; display:flex; justify-content:flex-end;">
        <button id="exportAllBtn" class="btn small primary" type="button">Minden felhasználó exportálása</button>
      </div>

        
      </section>

      <div class="gridUsers">
        <section class="panel" style="margin-top:0;">
          <div class="panelHead">
            <h2>Felhasználók</h2>
          </div>
          <div id="usersList" class="list"></div>
        </section>

        <section class="panel" style="margin-top:0;">
          <div class="panelHead">
            <h2>Felhasználó hozzáadása</h2>
          </div>

          <label>Email</label>
          <input id="invEmail" type="email" inputmode="email" autocomplete="email" />

          <label>Név</label>
          <input id="invName" type="text" autocomplete="name" />

          <label>Napi elvárt munkaidő</label>
          <div class="radioRow">
            <label><input type="radio" name="invDailyKind" value="8" checked> 8 órás</label>
            <label><input type="radio" name="invDailyKind" value="4"> 4 órás</label>
          </div>

          <div class="row2">
            <div>
              <label>Éves szabadság keret (nap)</label>
              <input id="invVacEnt" type="number" min="0" step="1" />
            </div>
            <div>
              <label>Előző évről áthozott szabadság (nap)</label>
              <input id="invVacCarry" type="number" min="0" step="1" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Előző évről áthozott csúsztatás (óra)</label>
              <input id="invFlexCarryH" type="number" step="0.25" />
            </div>
            <div>
              <label>Jutalom csúsztatás (óra)</label>
              <input id="invFlexBonusH" type="number" step="0.25" />
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button id="inviteBtn" class="btn primary" type="button">Hozzáadás</button>
          </div>
        </section>
      </div>

     
    </section>

    <!-- YEAR VIEW -->
    <section id="yearView" class="panel hidden">
      <div class="yearHeader">
        <div class="yearTitle">2026 – ünnepnapok és szombati munkanapok</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <button id="reloadYearBtn" class="btn" type="button">Újratöltés</button>
        </div>
      </div>

      <div id="monthsGrid" class="monthsGrid"></div>

      <div class="note">
        Színek: munkanap (fehér), pihenőnap (sötétszürke), hétvége (szürkés), ünnepnap (pasztell piros),
        szombati munkanap (fehér + zöld border).
      </div>
    </section>

    <!-- ENTRIES VIEW -->
    <section id="entriesView" class="panel hidden">
      <div class="entriesHead">
        <div style="min-width:0;">
          <h3 id="entriesTitle" class="entriesTitle">Rögzítések</h3>
          <div id="entriesMeta" class="entriesMeta">—</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
          <button id="backToUsersBtn" class="btn" type="button">Vissza</button>
          <button id="csvBtn" class="btn primary" type="button">CSV export</button>
        </div>
      </div>

      <div class="entriesWrap">
        <table class="entriesTable">
          <colgroup>
            <col style="width:12%">
            <col style="width:10%">
            <col style="width:10%">
            <col style="width:14%">
            <col style="width:14%">
            <col style="width:12%"><!-- Szabi -->
            <col style="width:12%"><!-- Beteg -->
            <col style="width:16%"><!-- Megjegyzés -->
          </colgroup>
          <thead>
            <tr>
              <th>Dátum</th>
              <th>Érkezés</th>
              <th>Távozás</th>
              <th>Ledolgozott órák</th>
              <th>Csúsztatás (perc)</th>
              <th>Szabadság</th>
              <th>Betegállomány</th>
              <th>Megjegyzés</th>
            </tr>
          </thead>
          <tbody id="entriesTbody">
            <tr><td colspan="8" class="muted">Betöltés…</td></tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- PROFILE EDIT MODAL -->
  <div id="backdrop" class="backdrop hidden">
    <div class="modal">
      <div class="modalHead">
        <div style="min-width:0;">
          <h3 id="mTitle" class="modalTitle">Profil szerkesztése</h3>
          <div id="mSub" class="who">—</div>
        </div>
        <div class="modalBtns">
          <button id="closeBtn" class="btn" type="button">Bezár</button>
          <button id="saveBtn" class="btn primary" type="button">Mentés</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row2">
        <div>
          <label>Név</label>
          <input id="mName" type="text" />
        </div>
        <div>
          <label>Email</label>
          <input id="mEmail" type="text" disabled />
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Szerep</label>
          <select id="mRole">
            <option value="user">user</option>
            <option value="manager">manager</option>
            <option value="admin">admin</option>
          </select>
        </div>
        <div>
          <label>Napi elvárt munkaidő (perc)</label>
          <input id="mDaily" type="number" min="0" step="1" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Éves szabadság keret (nap)</label>
          <input id="mVacEnt" type="number" min="0" step="1" />
        </div>
        <div>
          <label>Előző évről áthozott szabadság (nap)</label>
          <input id="mVacCarry" type="number" min="0" step="1" />
        </div>
      </div>

      <div class="row2">
        <div>
          <label>Előző évről áthozott csúsztatás (óra)</label>
          <input id="mFlexCarryH" type="number" step="0.25" />
        </div>
        <div>
          <label>Jutalom csúsztatás (óra)</label>
          <input id="mFlexBonusH" type="number" step="0.25" />
        </div>
      </div>

      <div class="note">
        A DB-ben a csúsztatás percekben van tárolva (flex_carryover_minutes / flex_bonus_minutes), itt órában mutatjuk.
      </div>
    </div>
  </div>

  <!-- YEAR DAY EDIT MODAL -->
  <div id="dayBackdrop" class="backdrop hidden">
    <div class="modal">
      <div class="modalHead">
        <div style="min-width:0;">
          <h3 id="dTitle" class="modalTitle">Dátum</h3>
          <div id="dSub" class="who">—</div>
        </div>
        <div class="modalBtns">
          <button id="dCloseBtn" class="btn" type="button">Bezár</button>
          <button id="dResetBtn" class="btn" type="button">Alapértelmezett</button>
          <button id="dSaveBtn" class="btn primary" type="button">Mentés</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="chkRow">
        <div class="left">Ünnepnap</div>
        <input id="dHolidayChk" type="checkbox" />
      </div>

      <div style="height:10px;"></div>

      <div id="holidayNameWrap">
        <label>Ünnep neve</label>
        <input id="dHolidayName" type="text" />
      </div>

      <div style="height:14px;"></div>

      <div id="workSatWrap" class="chkRow hidden">
        <div class="left">Szombati munkanap</div>
        <input id="dWorkSatChk" type="checkbox" />
      </div>

      <div class="note">
        Ünnepnap: is_workday=false + holiday_name. Szombati munkanap: special_workday=true + is_workday=true.
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = (id) => document.getElementById(id);

    const toast = (t) => {
      const el = document.createElement('div');
      el.className = 'toast';
      el.textContent = t;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2200);
    };

    let supabase = null;
    let me = null;
    let isMgr = false;

    // USERS state
    let profiles = [];
    let editing = null;

    // YEAR state
    const YEAR = 2026;
    let daysByIso = new Map();
    let editingIso = null;

    // Team summary cache
    let yearCalendarRows = null;
    let yearEntriesRows = null;
    let yearEntriesByUser = null;

    // ✅ TESZT "mai nap"
    // ÉLESÍTÉSHEZ: állítsd ''-re, és valódi mai napot fog használni.
    const DEV_TODAY = '2026-04-16';

    // Entries view state
    let entriesUser = null;
    let entriesRowsRendered = [];

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function normalizeIsoDate(d){ return String(d).slice(0,10); }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const s = String(hhmm);
      const p = s.slice(0,5).split(':').map(Number);
      if(p.length !== 2) return null;
      const [h,m] = p;
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.abs(Math.trunc(Number(mins)||0));
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function minsToHHMMPos(mins){
      const n = Math.max(0, Math.trunc(Number(mins)||0));
      const h = Math.floor(n/60);
      const mm = n%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function workedHoursFromArrivalDeparture(arrival, departure){
      const a = hhmmToMins(arrival);
      const b = hhmmToMins(departure);
      if(a == null || b == null) return '';
      if(b < a) return '';
      return minsToHHMMPos(b - a);
    }

    function daysBetween(aIso, bIso){
      const a = new Date(aIso + 'T12:00:00');
      const b = new Date(bIso + 'T12:00:00');
      return Math.round((b - a) / (24*60*60*1000));
    }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function* dateRangeInclusive(startIso, endIso){
      const start = new Date(startIso+'T12:00:00');
      const end = new Date(endIso+'T12:00:00');
      for(let d = new Date(start); d <= end; d.setDate(d.getDate()+1)){
        const y = d.getFullYear();
        const m = pad2(d.getMonth()+1);
        const da = pad2(d.getDate());
        yield `${y}-${m}-${da}`;
      }
    }

    async function fetchAll(makeQuery, pageSize=1000){
      let out = [];
      let from = 0;
      while(true){
        const { data, error } = await makeQuery(from, from+pageSize-1);
        if(error) throw error;
        out = out.concat(data || []);
        if(!data || data.length < pageSize) break;
        from += pageSize;
      }
      return out;
    }

    async function ensureYearCache(){
      const start = `${YEAR}-01-01`;
      const end = `${YEAR+1}-01-01`;

      if(!yearCalendarRows){
        const cal = await fetchAll((from,to)=>
          supabase
            .from('calendar_days')
            .select('date,is_workday,holiday_name,special_workday,year')
            .eq('year', YEAR)
            .order('date', { ascending:true })
            .range(from,to)
        );

        yearCalendarRows = (cal||[])
          .map(r=>({ ...r, date: normalizeIsoDate(r.date) }))
          .sort((a,b)=>a.date.localeCompare(b.date));
      }

      if(!yearEntriesRows){
        const ents = await fetchAll((from,to)=>
          supabase
            .from('entries')
            .select('user_id,date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
            .gte('date', start)
            .lt('date', end)
            .order('date', { ascending:true })
            .range(from,to)
        );

        yearEntriesRows = (ents||[]).map(e=>({ ...e, date: normalizeIsoDate(e.date) }));

        yearEntriesByUser = new Map();
        for(const e of yearEntriesRows){
          const uid = e.user_id;
          if(!yearEntriesByUser.has(uid)) yearEntriesByUser.set(uid, []);
          yearEntriesByUser.get(uid).push(e);
        }
      }
    }

    function calcUserMetrics(user, calendarRows, entriesRows){
      const today = getTodayISO();

      const expPerDay = Number(user.daily_expected_minutes ?? 480);
      const carry = Number(user.flex_carryover_minutes || 0);
      const bonus = Number(user.flex_bonus_minutes || 0);

      const vacTotal =
        Number(user.vacation_entitlement_days || 0) +
        Number(user.vacation_carryover_days || 0);

      const eMap = new Map();
      for(const e of (entriesRows||[])){
        eMap.set(normalizeIsoDate(e.date), e);
      }

      const calMap = new Map();
      for(const c of (calendarRows||[])){
        calMap.set(c.date, c);
      }

      // 1) túlóra/hátralék + hiány: today-ig
      let expectedTotal = 0;
      let fulfilledTotal = 0;
      let oldMissingCount = 0;

      for(const cal of (calendarRows||[])){
        const iso = cal.date;
        if(iso > today) break;

        const entry = eMap.get(iso);

        const isToday = (iso === today);
        const meaningfulToday =
          !!(entry && (
            (entry.arrival && entry.departure) ||
            (Number(entry.flex_minutes||0) > 0) ||
            !!entry.is_vacation ||
            !!entry.is_sick
          ));
        if(isToday && !meaningfulToday){
          continue;
        }

        const isWorkday = !!cal.is_workday;
        const isSpecial = !!cal.special_workday;

        if((isWorkday || isSpecial) && !entry && iso < today){
          if(daysBetween(iso, today) >= 14) oldMissingCount++;
        }

        const expected = isWorkday ? expPerDay : 0;
        expectedTotal += expected;

        let fulfilled = 0;

        if(entry){
          const vac = !!entry.is_vacation;
          const sick = !!entry.is_sick;

          if((vac || sick) && isWorkday){
            fulfilled += expected;
          }

          let worked = 0;
          if(entry.arrival && entry.departure){
            const inM = hhmmToMins(entry.arrival);
            const outM = hhmmToMins(entry.departure);
            if(inM != null && outM != null && outM >= inM){
              worked = outM - inM;
            }
          }
          const flexM = Math.max(0, Number(entry.flex_minutes || 0));
          worked = Math.max(0, worked - flexM);

          const isWeekendOrHolidayDouble = (!isWorkday && !isSpecial);
          let mult = 1;
          if(isWeekendOrHolidayDouble) mult = 2;
          if(vac && worked > 0) mult = 2;

          fulfilled += (worked * mult);
        }

        fulfilledTotal += fulfilled;
      }

      const balanceMin = (carry + bonus) + (fulfilledTotal - expectedTotal);

      const abs = Math.abs(balanceMin);
      const dayMins = Math.max(1, expPerDay || 480);
      const approxDays = Math.floor(abs / dayMins);

      // 2) szabadság (X/Y/Z) + beteg: teljes év
      let vacTakenToToday = 0;  // Z
      let vacRecordedAll = 0;   // (rögzített szabi az évben, jövő is)
      let sickDays = 0;

      for(const [iso, e] of eMap.entries()){
        const cal = calMap.get(iso);
        if(!cal || !cal.is_workday) continue;

        if(e?.is_vacation){
          vacRecordedAll++;
          if(iso <= today) vacTakenToToday++; // ma is benne
        }

        if(e?.is_sick) sickDays++;
      }

      const vacRemainToToday = vacTotal - vacTakenToToday; // X
      const vacUnplanned = vacTotal - vacRecordedAll;      // Y

      return {
        balanceMin,
        approxDays,
        vacRemainToToday,
        vacTakenToToday,
        vacUnplanned,
        sickDays,
        oldMissingCount
      };
    }

    function fmtBalanceCell(balanceMin, approxDays){
      const abs = Math.abs(Math.round(balanceMin));
      const hhmm = minsToHHMM(abs);

      const isPos = balanceMin >= 0;
      const label = isPos ? 'túlóra' : 'hátralék';
      const cls = isPos ? 'pos' : 'neg';

      return `
        <span class="${cls}">${hhmm}</span> óra,
        <span class="${cls}">${approxDays}</span> nap ${label}
      `;
    }

    // ✅ Manager: "X nap" / alatta: "Nincs kiírva Y nap" / alatta: "Már kivett Z napot."
    function fmtVacText(vacRemainToToday, vacUnplanned, vacTakenToToday){
      const X = Math.max(0, Math.round(Number(vacRemainToToday || 0)));
      const Y = Math.max(0, Math.round(Number(vacUnplanned || 0)));
      const Z = Math.max(0, Math.round(Number(vacTakenToToday || 0)));

      let html = `<div>${X} nap</div>`;

      if(Y !== 0){
        html += `<div class="muted" style="font-size:12px; margin-top:2px;">Nincs kiírva ${Y} nap</div>`;
      }
      if(Z !== 0){
        html += `<div class="muted" style="font-size:12px; margin-top:2px;">Már kivett ${Z} napot</div>`;
      }
      return html;
    }

    function timeToHHMM(t){
      if(!t) return '';
      const s = String(t);
      return s.length >= 5 ? s.slice(0,5) : s;
    }

    function safeFilePart(s){
      return String(s || '')
        .trim()
        .replace(/\s+/g,'_')
        .replace(/[^a-zA-Z0-9_\-áéíóöőúüűÁÉÍÓÖŐÚÜŰ]/g,'')
        .slice(0,60) || 'user';
    }

    function csvEscape(v, delim=';'){
      const s = String(v ?? '');
      const needs = s.includes('"') || s.includes('\n') || s.includes('\r') || s.includes(delim);
      if(!needs) return s;
      return '"' + s.replace(/"/g,'""') + '"';
    }

    function makeCsvString(rows, userDisplayName){
      const delim = ';';
      const header = ['Dátum','Érkezés','Távozás','Ledolgozott órák','Csúsztatás (perc)','Szabadság','Betegállomány','Megjegyzés'];

      const lines = [];
      // ✅ Excel delimiter hint
      lines.push(`sep=${delim}`);

      lines.push(['Felhasználó', userDisplayName || ''].map(x=>csvEscape(x,delim)).join(delim));
      lines.push(header.map(h=>csvEscape(h,delim)).join(delim));

      for(const r of rows){
        lines.push([
          r.date,
          r.arrival,
          r.departure,
          r.worked,
          r.flex_minutes,
          r.vacation,
          r.sick,
          r.note
        ].map(x=>csvEscape(x,delim)).join(delim));
      }

      return lines.join('\r\n');
    }

    // ✅ Excel társítva megnyitva is jól: UTF-16LE + BOM
    function utf16leBytes(str){
      const out = new Uint8Array(2 + str.length * 2);
      out[0] = 0xFF; // BOM
      out[1] = 0xFE;
      for(let i=0;i<str.length;i++){
        const code = str.charCodeAt(i);
        out[2 + i*2] = code & 0xFF;
        out[3 + i*2] = (code >> 8) & 0xFF;
      }
      return out;
    }

    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    }

    function downloadCsv(rows, filename, userDisplayName){
      const csvStr = makeCsvString(rows, userDisplayName);
      const bytes = utf16leBytes(csvStr);
      const blob = new Blob([bytes], { type:'text/csv;charset=utf-16le' });
      downloadBlob(blob, filename);
    }

    function buildRenderedRowsForUserEntries(entries, todayIso){
      const start = `${YEAR}-01-01`;
      const eMap = new Map();
      for(const e of (entries||[])){
        const d = normalizeIsoDate(e.date);
        eMap.set(d, { ...e, date:d });
      }

      const baseDates = Array.from(dateRangeInclusive(start, todayIso));

      const futureTagged = (entries||[])
        .map(e => ({ ...e, date: normalizeIsoDate(e.date) }))
        .filter(e => (e.is_vacation || e.is_sick) && e.date > todayIso)
        .map(e => e.date);

      const set = new Set(baseDates);
      futureTagged.forEach(d => set.add(d));

      const dates = Array.from(set).sort((a,b)=>a.localeCompare(b));

      const rows = [];
      for(const iso of dates){
        const e = eMap.get(iso);

        const arrival = e ? timeToHHMM(e.arrival) : '';
        const departure = e ? timeToHHMM(e.departure) : '';
        const worked = workedHoursFromArrivalDeparture(arrival, departure);

        const flexVal = e ? Number(e.flex_minutes || 0) : 0;
        const flex = (e && flexVal > 0) ? String(flexVal) : '';

        const vac = (e && e.is_vacation) ? 'Szabadság' : '';
        const sick = (e && e.is_sick) ? 'Betegállomány' : '';
        const note = e ? (e.note || '') : '';

        rows.push({
          date: iso.replaceAll('-','.'),
          arrival,
          departure,
          worked,
          flex_minutes: flex,
          vacation: vac,
          sick,
          note
        });
      }
      return rows;
    }

    async function exportAllUsersZip(){
      const btn = $('exportAllBtn');
      if(btn) btn.disabled = true;

      try{
        if(!window.JSZip){
          toast('ZIP könyvtár nem elérhető.');
          return;
        }

        await ensureSupabase();
        await ensureYearCache();

        const today = getTodayISO();
        const zip = new JSZip();

        const list = (profiles||[]).filter(p => p.role !== 'admin'); // admin nélkül

        if(list.length === 0){
          toast('Nincs felhasználó.');
          return;
        }

        for(const u of list){
          const uid = u.user_id;
          const entries = yearEntriesByUser?.get(uid) || [];
          const rows = buildRenderedRowsForUserEntries(entries, today);

          const userPart = safeFilePart(u.display_name || u.email || 'user');
          const uidPart = String(uid || '').slice(0,8) || 'uid';
          const filename = `${userPart}_${uidPart}_export_${today}.csv`;

          const display = u.display_name || u.email || '';
          const csvStr = makeCsvString(rows, display);
          const bytes = utf16leBytes(csvStr);

          zip.file(filename, bytes);
        }

        const zipBlob = await zip.generateAsync({ type:'blob' });
        const zipName = `kultora_export_all_${today}.zip`;
        downloadBlob(zipBlob, zipName);

      }catch(e){
        toast(e?.message || String(e));
      }finally{
        if(btn) btn.disabled = false;
      }
    }

    async function openEntriesView(user){
      entriesUser = user;

      $('tabsRow').classList.add('hidden');

      $('usersView').classList.add('hidden');
      $('yearView').classList.add('hidden');
      $('entriesView').classList.remove('hidden');

      const today = getTodayISO();
      const name = user.display_name || user.email || '(névtelen)';
      $('entriesTitle').textContent = `Rögzítések – ${name}`;
      $('entriesMeta').textContent = `Listázva: ${YEAR}-01-01 → ${today} (jövőből csak előre rögzített szabadságok/betegállomány)`;

      const tbody = $('entriesTbody');
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Betöltés…</td></tr>`;

      try{
        const start = `${YEAR}-01-01`;
        const end = `${YEAR+1}-01-01`;

        const { data, error } = await supabase
          .from('entries')
          .select('date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
          .eq('user_id', user.user_id)
          .gte('date', start)
          .lt('date', end)
          .order('date', { ascending:true });

        if(error) throw error;

        const entries = (data||[]).map(e=>({ ...e, date: normalizeIsoDate(e.date) }));

        const eMap = new Map();
        for(const e of entries){
          eMap.set(e.date, e);
        }

        const baseDates = Array.from(dateRangeInclusive(start, today));

        const futureTagged = entries
          .filter(e => (e.is_vacation || e.is_sick) && e.date > today)
          .map(e => e.date)
          .sort();

        const dates = baseDates.concat(futureTagged);

        entriesRowsRendered = [];

        tbody.innerHTML = '';
        for(const iso of dates){
          const e = eMap.get(iso);

          const arrival = e ? timeToHHMM(e.arrival) : '';
          const departure = e ? timeToHHMM(e.departure) : '';
          const worked = workedHoursFromArrivalDeparture(arrival, departure);

          const flexVal = e ? Number(e.flex_minutes || 0) : 0;
          const flex = (e && flexVal > 0) ? String(flexVal) : '';

          const vac = (e && e.is_vacation) ? 'Szabadság' : '';
          const sick = (e && e.is_sick) ? 'Betegállomány' : '';
          const note = e ? (e.note || '') : '';

          entriesRowsRendered.push({
            date: iso.replaceAll('-','.'),
            arrival,
            departure,
            worked,
            flex_minutes: flex,
            vacation: vac,
            sick,
            note
          });

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(iso.replaceAll('-','.'))}</td>
            <td>${escapeHtml(arrival)}</td>
            <td>${escapeHtml(departure)}</td>
            <td>${escapeHtml(worked)}</td>
            <td>${escapeHtml(flex)}</td>
            <td>${vac ? `<span class="vacPill">Szabadság</span>` : ''}</td>
            <td>${sick ? `<span class="sickPill">Betegállomány</span>` : ''}</td>
            <td class="noteCell">${escapeHtml(note)}</td>
          `;
          tbody.appendChild(tr);
        }

        if(dates.length === 0){
          tbody.innerHTML = `<tr><td colspan="8" class="muted">Nincs adat.</td></tr>`;
        }

      }catch(e){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">${escapeHtml(e?.message || String(e))}</td></tr>`;
      }
    }

    function closeEntriesView(){
      entriesUser = null;
      entriesRowsRendered = [];

      $('entriesView').classList.add('hidden');
      $('tabsRow').classList.remove('hidden');

      setTab('users');
    }

    function setTab(tab){
      $('tabUsers').classList.toggle('active', tab==='users');
      $('tabYear').classList.toggle('active', tab==='year');

      $('usersView').classList.toggle('hidden', tab!=='users');
      $('yearView').classList.toggle('hidden', tab!=='year');

      $('entriesView').classList.add('hidden');
      $('tabsRow').classList.remove('hidden');
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' }
      });
      return supabase;
    }

    function hoursToMinutes(h){
      if(h === null || h === undefined || h === '') return 0;
      const n = Number(h);
      if(Number.isNaN(n)) return 0;
      return Math.round(n * 60);
    }
    function minutesToHours(m){
      const n = Number(m||0);
      return (n/60).toFixed(2).replace(/\.00$/, '');
    }

    function roleBadge(role){
      if(role === 'admin') return `<span class="pill admin">admin</span>`;
      if(role === 'manager') return `<span class="pill manager">manager</span>`;
      return '';
    }
    function roleWeight(role){
      if(role === 'admin') return 0;
      if(role === 'manager') return 1;
      return 2;
    }

    function escapeHtml(s){
      return String(s||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function getDailyMinutesFromRadio(){
      const v = document.querySelector('input[name="invDailyKind"]:checked')?.value;
      return (v === '4') ? 240 : 480;
    }

    async function saveInvite(){
      const email = ($('invEmail').value || '').trim().toLowerCase();
      const name  = ($('invName').value || '').trim();
      if(!email) { toast('Adj meg emailt'); return; }

      const payload = {
        email,
        display_name: name || null,
        role: 'user',

        daily_expected_minutes: getDailyMinutesFromRadio(),
        vacation_entitlement_days: Number($('invVacEnt').value || 0),
        vacation_carryover_days: Number($('invVacCarry').value || 0),
        flex_carryover_minutes: hoursToMinutes($('invFlexCarryH').value),
        flex_bonus_minutes: hoursToMinutes($('invFlexBonusH').value),
      };

      const { error } = await supabase
        .from('user_invites')
        .upsert(payload, { onConflict:'email' });

      if(error) throw new Error(error.message || String(error));

      toast('Hozzáadva');
      $('invEmail').value = '';
      $('invName').value = '';
      $('invVacEnt').value = '';
      $('invVacCarry').value = '';
      $('invFlexCarryH').value = '';
      $('invFlexBonusH').value = '';
    }

    function renderUsers(){
      const el = $('usersList');
      el.innerHTML = '';
      for(const p of profiles){
        const card = document.createElement('div');
        card.className = 'userCard';

        const meta = document.createElement('div');
        meta.className = 'userMeta';
        meta.innerHTML = `
          <div class="userNameRow">
            <div class="userName">${escapeHtml(p.display_name || '(névtelen)')}</div>
            ${roleBadge(p.role)}
          </div>
          <div class="userEmail">${escapeHtml(p.email || '')}</div>
        `;

        const actions = document.createElement('div');
        actions.className = 'actions';
        const btn = document.createElement('button');
        btn.className = 'btn small';
        btn.type = 'button';
        btn.textContent = 'Szerkesztés';
        btn.addEventListener('click', () => openEditProfile(p));
        actions.appendChild(btn);

        card.appendChild(meta);
        card.appendChild(actions);
        el.appendChild(card);
      }
    }

    function openEditProfile(p){
      editing = {...p};
      $('mTitle').textContent = 'Profil szerkesztése';
      $('mSub').textContent = `${p.email || ''} • user_id: ${p.user_id}`;

      $('mName').value = p.display_name || '';
      $('mEmail').value = p.email || '';

      $('mRole').value = p.role || 'user';
      $('mDaily').value = p.daily_expected_minutes ?? 480;

      $('mVacEnt').value = p.vacation_entitlement_days ?? 0;
      $('mVacCarry').value = p.vacation_carryover_days ?? 0;

      $('mFlexCarryH').value = minutesToHours(p.flex_carryover_minutes);
      $('mFlexBonusH').value = minutesToHours(p.flex_bonus_minutes);

      $('backdrop').classList.remove('hidden');
    }
    function closeEditProfile(){
      $('backdrop').classList.add('hidden');
      editing = null;
    }

    async function saveEditProfile(){
      if(!editing) return;

      const patch = {
        display_name: ($('mName').value || '').trim(),
        role: $('mRole').value,
        daily_expected_minutes: Number($('mDaily').value || 0),

        vacation_entitlement_days: Number($('mVacEnt').value || 0),
        vacation_carryover_days: Number($('mVacCarry').value || 0),

        flex_carryover_minutes: hoursToMinutes($('mFlexCarryH').value),
        flex_bonus_minutes: hoursToMinutes($('mFlexBonusH').value),
      };

      const { error } = await supabase
        .from('profiles')
        .update(patch)
        .eq('user_id', editing.user_id);

      if(error) throw error;

      toast('Mentve');
      closeEditProfile();
      await refreshAll();
    }

    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }
    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }
    function isSaturdayISO(iso){
      const d = new Date(iso+'T12:00:00');
      return d.getDay() === 6;
    }

    function tileClass(row){
      const iso = row.date;
      const isHol = (!row.is_workday && !!row.holiday_name);

      if(isHol) return 'miniTile holiday';
      if(!!row.special_workday) return 'miniTile workSaturday';
      if(isWeekendISO(iso)) return 'miniTile weekend';
      if(!row.is_workday) return 'miniTile rest';
      return 'miniTile';
    }

    function iso(y,m,d){
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }

    function renderYear(){
      const host = $('monthsGrid');
      host.innerHTML = '';

      for(let m=1;m<=12;m++){
        const card = document.createElement('div');
        card.className = 'monthCard';

        const h = document.createElement('div');
        h.className = 'monthName';
        h.textContent = `${huMonthName(m)} ${YEAR}`;
        card.appendChild(h);

        const dow = document.createElement('div');
        dow.className = 'dowMini';
        dow.innerHTML = `<div>H</div><div>K</div><div>SZ</div><div>CS</div><div>P</div><div>SZO</div><div>V</div>`;
        card.appendChild(dow);

        const grid = document.createElement('div');
        grid.className = 'miniGrid';

        const first = new Date(`${YEAR}-${String(m).padStart(2,'0')}-01T12:00:00`);
        let wd = first.getDay(); wd = wd===0 ? 7 : wd;
        const offset = wd-1;

        const last = new Date(YEAR, m, 0, 12,0,0);
        const daysInMonth = last.getDate();

        for(let i=0;i<42;i++){
          const cell = document.createElement('div');

          if(i<offset || (i-offset)>=daysInMonth){
            cell.className = 'miniTile rest';
            cell.style.opacity = '.20';
            grid.appendChild(cell);
            continue;
          }

          const dayNum = (i-offset)+1;
          const dIso = iso(YEAR, m, dayNum);

          const row = daysByIso.get(dIso);
          const r = row || { date:dIso, year:YEAR, is_workday: !isWeekendISO(dIso), holiday_name:null, special_workday:false };

          cell.className = tileClass(r);

          const dn = document.createElement('div');
          dn.className = 'miniDay';
          dn.textContent = String(dayNum);
          cell.appendChild(dn);

          if(r.holiday_name){
            const hint = document.createElement('div');
            hint.className = 'miniHint';
            hint.textContent = r.holiday_name;
            cell.appendChild(hint);
          }

          cell.addEventListener('click', ()=>openDayEditor(r));
          grid.appendChild(cell);
        }

        card.appendChild(grid);
        host.appendChild(card);
      }
    }

    function openDayEditor(row){
      editingIso = row.date;
      $('dTitle').textContent = row.date.replaceAll('-', '.');
      $('dSub').textContent =
        row.holiday_name ? `Ünnep: ${row.holiday_name}` :
        row.special_workday ? 'Szombati munkanap' :
        row.is_workday ? 'Munkanap' : 'Pihenőnap';

      const isHol = (!row.is_workday && !!row.holiday_name);
      $('dHolidayChk').checked = isHol;
      $('dHolidayName').value = row.holiday_name || '';

      const sat = isSaturdayISO(row.date);
      $('workSatWrap').classList.toggle('hidden', !sat);

      $('dWorkSatChk').checked = !!row.special_workday;
      $('holidayNameWrap').style.display = $('dHolidayChk').checked ? 'block' : 'none';

      $('dayBackdrop').classList.remove('hidden');
    }

    function closeDayEditor(){
      $('dayBackdrop').classList.add('hidden');
      editingIso = null;
    }

    function currentEditedRow(){
      if(!editingIso) return null;
      return daysByIso.get(editingIso);
    }

    function computeDefaultForIso(isoStr){
      const weekend = isWeekendISO(isoStr);
      return {
        date: isoStr,
        year: YEAR,
        is_workday: !weekend,
        holiday_name: null,
        special_workday: false
      };
    }

    async function saveDayEditor(){
      const row = currentEditedRow();
      if(!row) return;

      const isoStr = row.date;
      const sat = isSaturdayISO(isoStr);

      const holidayOn = $('dHolidayChk').checked;
      let holidayName = ($('dHolidayName').value || '').trim();

      const workSatOn = sat ? $('dWorkSatChk').checked : false;

      let patch = {};

      if(holidayOn){
        if(!holidayName){
          toast('Adj meg ünnepnevet');
          return;
        }
        patch = { is_workday:false, holiday_name:holidayName, special_workday:false };
      }else if(workSatOn){
        patch = { is_workday:true, holiday_name:null, special_workday:true };
      }else{
        patch = { holiday_name:null, special_workday:false };
      }

      const { error } = await supabase
        .from('calendar_days')
        .update(patch)
        .eq('date', isoStr);

      if(error) throw error;

      const newRow = { ...row, ...patch };
      daysByIso.set(isoStr, newRow);

      toast('Mentve');
      closeDayEditor();
      renderYear();
    }

    async function resetDayEditor(){
      const row = currentEditedRow();
      if(!row) return;

      const def = computeDefaultForIso(row.date);

      const { error } = await supabase
        .from('calendar_days')
        .update({ is_workday:def.is_workday, holiday_name:null, special_workday:false })
        .eq('date', row.date);

      if(error) throw error;

      daysByIso.set(row.date, { ...row, is_workday:def.is_workday, holiday_name:null, special_workday:false });

      toast('Alapértelmezett');
      closeDayEditor();
      renderYear();
    }

    async function loadYear(){
      const { data, error } = await supabase
        .from('calendar_days')
        .select('date,year,is_workday,holiday_name,special_workday')
        .eq('year', YEAR)
        .order('date', { ascending:true });

      if(error) throw error;

      daysByIso = new Map();
      (data||[]).forEach(r=>{
        const d = String(r.date).slice(0,10);
        daysByIso.set(d, { ...r, date:d });
      });

      renderYear();
    }

    async function refreshAll(){
      await ensureSupabase();

      const { data: sess } = await supabase.auth.getSession();
      if(!sess.session){
        location.replace('/index.html?v=' + Date.now());
        return;
      }

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: myProf, error: e1 } = await supabase
        .from('profiles')
        .select('user_id,email,display_name,role')
        .eq('user_id', uid)
        .maybeSingle();
      if(e1) throw e1;

      me = myProf;
      isMgr = (me?.role === 'manager' || me?.role === 'admin');
      $('who').textContent = me ? `${me.display_name || me.email || ''} (${me.role})` : '—';

      if(!isMgr){
        toast('Nincs jogosultság');
        setTimeout(()=>location.replace('/app.html'), 700);
        return;
      }

      const { data: all, error: e2 } = await supabase
        .from('profiles')
        .select('user_id,email,display_name,role,daily_expected_minutes,vacation_entitlement_days,vacation_carryover_days,flex_carryover_minutes,flex_bonus_minutes');
      if(e2) throw e2;

      profiles = (all || []).slice().sort((a,b)=>{
        const wa = roleWeight(a.role);
        const wb = roleWeight(b.role);
        if(wa !== wb) return wa - wb;

        const an = (a.display_name || a.email || '').toLocaleLowerCase('hu');
        const bn = (b.display_name || b.email || '').toLocaleLowerCase('hu');
        return an.localeCompare(bn, 'hu');
      });

      renderUsers();

      yearCalendarRows = null;
      yearEntriesRows = null;
      yearEntriesByUser = null;
      await renderTeamSummary();
    }

    async function renderTeamSummary(){
      const tbody = $('teamTbody');
      if(!tbody) return;

      try{
        await ensureYearCache();

        const today = getTodayISO();
        $('sumMeta').textContent = `Számolva eddig: ${today.replaceAll('-','.')}`;

        tbody.innerHTML = '';

        const list = (profiles||[]).filter(p => p.role !== 'admin');

        const sorted = list.slice().sort((a,b)=>{
          const wa = roleWeight(a.role);
          const wb = roleWeight(b.role);
          if(wa !== wb) return wa - wb;
          const an = (a.display_name || a.email || '').toLocaleLowerCase('hu');
          const bn = (b.display_name || b.email || '').toLocaleLowerCase('hu');
          return an.localeCompare(bn, 'hu');
        });

        for(const u of sorted){
          const uid = u.user_id;
          const myEntries = yearEntriesByUser?.get(uid) || [];
          const m = calcUserMetrics(u, yearCalendarRows, myEntries);

          const tr = document.createElement('tr');

          const roleLabel = (u.role === 'manager')
            ? `<span class="summaryTag" style="border-color:rgba(37,99,235,.45); background:rgba(37,99,235,.10);">manager</span>`
            : '';

          tr.innerHTML = `
            <td>
              ${escapeHtml(u.display_name || u.email || '(névtelen)')}
              ${roleLabel}
            </td>
            <td>${fmtBalanceCell(m.balanceMin, m.approxDays)}</td>
            <td class="wrapCell">${fmtVacText(m.vacRemainToToday, m.vacUnplanned, m.vacTakenToToday)}</td>
            <td>${Math.max(0, Math.round(m.sickDays || 0))} <span class="muted">nap</span></td>
            <td>${m.oldMissingCount} <span class="muted">db</span></td>
            <td>
              <button class="sumIconBtn" type="button" aria-label="Táblázat" data-open-entries="${escapeHtml(uid)}">
                <span class="material-symbols-outlined" aria-hidden="true">article</span>
                <span class="sumIconLabel">Táblázat</span>
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        }

        if(sorted.length === 0){
          tbody.innerHTML = `<tr><td colspan="6" class="muted">Nincs felhasználó.</td></tr>`;
        }

        tbody.querySelectorAll('button[data-open-entries]').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const uid = btn.getAttribute('data-open-entries');
            const u = profiles.find(x => String(x.user_id) === String(uid));
            if(!u){ toast('Nincs user'); return; }
            await openEntriesView(u);
          });
        });

      }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" class="muted">${escapeHtml(e?.message || String(e))}</td></tr>`;
      }
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      try{
        await ensureSupabase();

        $('refreshBtn').addEventListener('click', async ()=>{
          const wasEntries = !$('entriesView').classList.contains('hidden');
          const keepUser = entriesUser;

          await refreshAll();
          toast('Frissítve');

          if(wasEntries && keepUser){
            await openEntriesView(keepUser);
          }
        });

        $('logoutBtn').addEventListener('click', async ()=>{
          try{ await supabase.auth.signOut(); }catch(_){}
          location.replace('/index.html?v=' + Date.now());
        });

        $('tabUsers').addEventListener('click', ()=>setTab('users'));
        $('tabYear').addEventListener('click', async ()=>{
          setTab('year');
          await loadYear();
        });

        $('backToUsersBtn').addEventListener('click', closeEntriesView);

        $('csvBtn').addEventListener('click', ()=>{
          if(!entriesUser) return;
          const today = getTodayISO();
          const userPart = safeFilePart(entriesUser.display_name || entriesUser.email || 'user');
          const filename = `${userPart}_export_${today}.csv`;
          downloadCsv(entriesRowsRendered, filename, entriesUser.display_name || entriesUser.email || '');
        });

        $('exportAllBtn').addEventListener('click', exportAllUsersZip);

        $('closeBtn').addEventListener('click', closeEditProfile);
        $('backdrop').addEventListener('click', (e)=>{ if(e.target === $('backdrop')) closeEditProfile(); });
        $('saveBtn').addEventListener('click', async ()=>{ try{ await saveEditProfile(); }catch(e){ toast(e.message||String(e)); } });

        $('inviteBtn').addEventListener('click', async ()=>{ try{ await saveInvite(); await refreshAll(); }catch(e){ toast(e.message||String(e)); } });

        $('reloadYearBtn').addEventListener('click', async ()=>{ try{ await loadYear(); toast('Naptár frissítve'); }catch(e){ toast(e.message||String(e)); } });

        $('dCloseBtn').addEventListener('click', closeDayEditor);
        $('dayBackdrop').addEventListener('click', (e)=>{ if(e.target === $('dayBackdrop')) closeDayEditor(); });

        $('dHolidayChk').addEventListener('change', ()=>{
          const on = $('dHolidayChk').checked;
          $('holidayNameWrap').style.display = on ? 'block' : 'none';
          if(on){
            $('dWorkSatChk').checked = false;
          }
        });

        $('dWorkSatChk').addEventListener('change', ()=>{
          if($('dWorkSatChk').checked){
            $('dHolidayChk').checked = false;
            $('holidayNameWrap').style.display = 'none';
            $('dHolidayName').value = '';
          }
        });

        $('dSaveBtn').addEventListener('click', async ()=>{ try{ await saveDayEditor(); }catch(e){ toast(e.message||String(e)); } });
        $('dResetBtn').addEventListener('click', async ()=>{ try{ await resetDayEditor(); }catch(e){ toast(e.message||String(e)); } });

        await refreshAll();
        setTab('users');
      }catch(e){
        toast(e?.message || String(e));
      }
    });

    function closeEditProfile(){
      $('backdrop').classList.add('hidden');
      editing = null;
    }
    function closeDayEditor(){
      $('dayBackdrop').classList.add('hidden');
      editingIso = null;
    }
  })();
  </script>
</body>
</html>
