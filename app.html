<!-- app.html -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VMKK KultÓra</title>

  <meta name="theme-color" content="#27272a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VMKK KultÓra" />

  <link rel="manifest" href="/manifest.webmanifest?v=1" />

  <link rel="icon" type="image/png" href="/kult_logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=1" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png?v=1" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png?v=1" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#777b81;
      --zold:#1ecb5b;
      --piros:#ff3b30;

      --sick:#1ecb5b;

      --inactive:#52525b;   /* inaktív háttér */
      --inactiveLbl:#9ca3af;/* inaktív felirat */
    }

html[data-theme="light"]{
  --bg:#f3f4f6;
  --panel:#ffffff;
  --text:#111827;
  --muted:#6b7280;

  --rest:#e5e7eb;
  --holiday:#fecaca;
  --vac:#bfdbfe;
  --work:#ffffff;
  --weekend:#d1d5db;

  --border:#e5e7eb;
  --card:#ffffff;

  --inactive:#e5e7eb;
  --inactiveLbl:#6b7280;

  /* ha kell: a zöld/piros maradhat */
}

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* ---------- HEADER ---------- */
    .header{
      max-width:900px;
      margin:0 auto;
      padding:8px 12px 6px;
      min-height:52px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      background:transparent;
      gap:10px;
    }

    .user-block{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }

    .user-meta{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .user-name{
      font-weight:700;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:56vw;
      line-height:1.1;
    }

    .nav-container{
      display:flex;
      gap:0;
      align-items:center;
    }

    .nav-item{
      border:0;
      background:transparent;
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      width:44px;
      height:42px;
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      padding:0;
    }

    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      transition:color 0.2s ease;
      line-height:1;
    }

    .menu-label{
      font-size:10px;
      position:absolute;
      bottom:4px;
      left:50%;
      transform:translateX(-50%);
      white-space:nowrap;
      pointer-events:none;
      transition:opacity 0.2s ease, color 0.2s ease;
    }

    /* Kilépés: fehér ikon + fehér felirat */
    .logout-item .material-symbols-outlined,
    .logout-item .menu-label{
      color:var(--text);
      opacity:1;
    }

    .nav-item:hover .material-symbols-outlined,
    .nav-item:hover .menu-label{color:var(--accent);}

    .settings-item .menu-label{display:none !important;}

    /* ---------- MAIN ---------- */
    .wrap{max-width:900px; margin:0 auto; padding:0px;}
    .card{background:var(--panel); border:0; border-radius:16px; padding:6px;}
    .hidden{display:none !important;}

    .pager{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:0px 0px 20px;
    }
    .arrow{
      width:9%;
      min-width:64px;
      height:36px;
      display:flex; align-items:center; justify-content:center;
      background:#1ecb5b;
      border-radius:0px;
      cursor:pointer;
      user-select:none;
      font-size:32px;
      transition:background 0.2s;
    }
    .arrow:hover{background:#1ecb5b;}
    .spacer{width:14%;}
    .title{width:42%; text-align:center; font-size:1rem; font-weight:800;}

    .dow{
      height:1vh; min-height:20px;
      display:grid; grid-template-columns:repeat(7,1fr); gap:8px;
      align-items:center; margin-top:4px;
    }
    .dow div{
      text-align:center;
      font-size:16px;
      font-weight:600;
    }

    .gridWrap{height:60vh; min-height:360px; margin-top:8px;}
    .grid{
      height:100%;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      grid-template-rows:repeat(6,1fr);
      gap:3px;
    }

    .tile{
      background:var(--work);
      border-radius:0px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      cursor:pointer;
      position:relative;
      border:1px solid #3f3f46;
      padding:0.2rem;
      transition:transform 0.2s;
    }
    .tile:hover{transform:scale(1.05);}
    .tile:active{transform:scale(0.95);}

    .tile.rest{background:var(--rest); opacity:1;}
    .tile.weekend{background:var(--weekend);}
    .tile.holiday{background:var(--holiday);}
    .tile.vac{background:var(--vac);}
    .tile.sick{background:var(--sick);}
    .tile.workSaturday{background:var(--work); border:0;}
    .tile.todayFill{background:var(--accent) !important; color:#111;}

    .tTop{
      height:auto;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:0;
      margin-bottom:0.25rem;
    }
    .tDay{
      font-size:1.2rem;
      font-weight:900;
      line-height:1;
      text-align:left;
    }

    .lines{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
      justify-content:flex-start;
    }
    .line{
      font-size:0.75rem;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:600;
    }

    .tile .tDay{color:#000;}
    .tile .line{color:#374151;}

    .tile.weekend .tDay{color:#fff;}
    .tile.weekend .line{color:#e5e7eb;}

    .tile.rest .tDay{color:#9ca3af;}
    .tile.rest .line{color:#9ca3af;}

    .tile.todayFill .tDay{color:#111;}
    .tile.todayFill .line{color:#fff;}

    /* beteg nap: sötétebb szöveg olvashatóság */
    .tile.sick .tDay{color:#111;}
    .tile.sick .line{color:#111;}

    .line.red{color:var(--piros) !important;}
    .line.black{color:#111 !important;}

    .jumpWrap{padding:6px 0 0;}
    .jumpBtn{
      width:100%;
      border:0;
      border-radius:6px;
      height:44px;
      background:var(--zold);
      color:#111;
      font-size:1rem;
      font-weight:900;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .jumpBtn:active{opacity:.9;}

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:20px;
      z-index:99;
    }

    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(900px,100%);
      background:#8f8f8f;
      border-radius:0px;
      padding:18px;
      border:1px solid rgba(255,255,255,.10);
    }
    .modalHeader{font-size:34px; font-weight:800; margin:0 0 8px 0;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:1px; flex-wrap:wrap;}
    .row label{font-size:20px; font-weight:400; margin-right:10px;} /* min-width:140px;} */
    .row .ctrl{flex:1; min-width:180px;}

    /* select külön, textarea külön (✅ megjegyzés full szélesség) */
    select{
      width:30%;
      padding:4px 4px;
      border-radius:0px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      color:#111;
      font-size:0.7rem;
      outline:none;
    }
    textarea{
      width:100%;
      padding:4px 4px;
      border-radius:0px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      color:#111;
      font-size:0.7rem;
      outline:none;
    }

    select:disabled, textarea:disabled{
      background:var(--inactive) !important;
      color:#e5e7eb !important;
      border-color:rgba(255,255,255,.14) !important;
    }
    .labelDisabled{ color:var(--inactiveLbl) !important; }

    /* ✅ max 2 sor magas megjegyzés */
    #noteTxt{
      line-height:1.2;
      min-height:2.6em;
      max-height:2.6em;
      resize:none;
      overflow:auto;
    }

    .gap10{height:10px;}
    .gap20{height:20px;}
    .gap30{height:30px;}
    .gap40{height:40px;}
    .gap50{height:50px;}

    .btnRow{display:flex; gap:12px; margin-top:12px;}
    .btn{
      border:0; border-radius:6px;
      padding:0px 0px;
      font-size:1rem;
      cursor:pointer;
      flex:1;
      height:34px;
    }
    .btn.danger{background:#c9cbd1; color:#111; font-weight:900;}
    .btn.mentes{background:#1ecb5b; color:#111; font-weight:900;}
    .btn:disabled{opacity:.55; cursor:not-allowed;}

    .errBig{font-size:22px; color:#ff3b30; margin-top:10px; font-weight:900;}
    .invalid select{background:#ffd1d1 !important; border:3px solid #ff3b30 !important;}

    .noVac{
      font-size:12px;
      color:var(--piros);
      font-weight:800;
    }

    .noSick{
      font-size:12px;
      color:var(--piros);
      font-weight:800;
    }

    /* ✅ QUICK BUTTONS (dátum alatt, Érkezés előtt) */
    .qpRow{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
      gap:8px;

      /* könnyen állítható */
      margin: 0 0 10px 0;
      padding: 0;
    }
    .qpBtn{
      background: var(--zold);
      color:#111;
      border:0;
      border-radius:6px;
      cursor:pointer;
      font-weight:900;
      font-size:1rem;
      line-height:1;

      /* könnyen állítható */
      padding: 6px 10px;
      margin: 0;

      -webkit-tap-highlight-color:transparent;
    }
    .qpBtn:active{opacity:.9;}
    .qpBtn:disabled{opacity:.55; cursor:not-allowed;}

    @media (max-width:520px){
      .title{font-size:1rem;}
      .dow div{font-size:14px;}
      .modalHeader{font-size:1.2rem;}
      .row label{font-size:1rem;}
      select, textarea{font-size:0.7rem;}
      .btn{font-size:1rem;}
      .tDay{font-size:1rem;}
      .line{font-size:0.625rem;}
      .nav-item{width:42px;}
      .user-name{max-width:64vw;}

      select{width:30%;}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <header class="header">
    <div class="user-block">
      <div class="user-meta">
        <div id="userName" class="user-name"></div>
      </div>

      <button id="logoutBtn" class="nav-item logout-item" type="button" aria-label="Kilépés">
        <span class="material-symbols-outlined">logout</span>
        <span class="menu-label">Kilépés</span>
      </button>
    </div>

    <nav class="nav-container">
      <button id="sumBtn" class="nav-item" type="button" aria-label="Összesítő">
        <span class="material-symbols-outlined">overview</span>
        <span class="menu-label">Összesítő</span>
      </button>

      <button id="settingsBtn" class="nav-item settings-item hidden" type="button" aria-label="Beállítások">
        <span class="material-symbols-outlined">settings</span>
        <span class="menu-label">Beállítások</span>
      </button>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="pager">
        <div id="prevBtn" class="arrow">‹</div>
        <div class="spacer"></div>
        <div id="monthTitle" class="title">2026 Április</div>
        <div class="spacer"></div>
        <div id="nextBtn" class="arrow">›</div>
      </div>

      <div class="dow">
        <div>H</div><div>K</div><div>SZ</div><div>CS</div><div>P</div><div>SZO</div><div>V</div>
      </div>

      <div class="gridWrap">
        <div id="grid" class="grid"></div>
      </div>
      <div class="jumpWrap">
        <button id="jumpTodayBtn" class="jumpBtn hidden" type="button">Ugrás a mai napra</button>
      </div>
    </section>
  </main>

  <div id="modalBackdrop" class="modalBackdrop hidden">
    <div class="modal">
      <div id="editDate" class="modalHeader">2026.04.16</div>

      <!-- ✅ gyorsgombok: dátum alatt, Érkezés előtt, egy sorban -->
      <div id="quickPairsRow" class="qpRow hidden"></div>

      <div class="row" style="margin-top:10px;">
        <label id="arrLbl">Érkezés</label>
        <div class="ctrl"><select id="arrSel"></select></div>
      </div>

      <div class="gap10"></div>

      <div class="row">
        <label id="depLbl">Távozás</label>
        <div class="ctrl"><select id="depSel"></select></div>
      </div>

      <div class="gap30"></div>

      <div class="row">
        <label id="flexLbl">Csúsztatás</label>
        <div class="ctrl"><select id="flexSel"></select></div>
      </div>

      <div class="gap20"></div>

      <div class="row">
        <label id="vacLbl">Szabi ezen a napon</label>
        <div class="ctrl" style="display:flex; align-items:center; justify-content:flex-start; gap:12px;">
          <input id="vacChk" type="checkbox" style="width:28px; height:28px; cursor:pointer;" />
          <span id="noVacMsg" class="noVac hidden">Nincs már kiírható szabid.</span>
        </div>
      </div>

      <div class="gap10"></div>

      <div class="row">
        <label id="sickLbl">Betegállomány</label>
        <div class="ctrl" style="display:flex; align-items:center; justify-content:flex-start; gap:12px;">
          <input id="sickChk" type="checkbox" style="width:28px; height:28px; cursor:pointer;" />
          <span id="noSickMsg" class="noSick hidden">Hétvégén / ünnepnapon nem jelölhető.</span>
        </div>
      </div>

      <div class="gap20"></div>

      <div class="row">
        <label id="noteLbl">Megjegyzés</label>
        <div class="ctrl"><textarea id="noteTxt" placeholder="pl. csúsztatás oka, rendezvény neve, stb."></textarea></div>
      </div>

      <div id="editErr" class="errBig hidden"></div>

      <div class="btnRow">
        <button id="delBtn" class="btn danger" type="button">Törlés</button>
        <button id="saveBtn" class="btn mentes" type="button">Vissza</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = (id)=>document.getElementById(id);
    const toast = (t)=>{
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=t;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    };

    // DEV_TODAY: ha null/'' => valódi mai nap
    const DEV_TODAY = '2026-01-16';

    let supabase = null;
    let profile = null;
    let currentUserId = null;

    // quick_pairs (max 3) – DB tábla: user_quick_pairs, fallback localStorage
    let quickPairs = []; // [{arrival:'08:00', departure:'16:00', id?}]

    let curYear = 2026;
    let curMonth = 4;

    let monthRows = [];
    let entriesByDate = new Map();

    let editingDate = null;
    let editingCalRow = null;

    let yearCalMap = new Map();
    let yearEntryMap = new Map();
    let yearVacUsed = 0;
    let vacTotalEntitlement = 0;

    let initialEditState = null;
    let formDirty = false;
    let formInvalid = false;

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function normalizeIsoDate(d){
      return String(d).slice(0,10);
    }

    // ====== ✅ THEME átvétel adatlapról (localStorage kulcs alapján) ======
    const THEME_LOCAL_KEY = 'kultora_theme';

    function applyTheme(theme){
      const t = (theme === 'light') ? 'light' : 'dark';
      document.documentElement.dataset.theme = t;

      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta){
        meta.setAttribute('content', t === 'light' ? '#f3f4f6' : '#27272a');
      }
    }

    function getThemeFromLocal(){
      try{
        return localStorage.getItem(THEME_LOCAL_KEY);
      }catch(_){
        return null;
      }
    }

    // induláskor: ha adatlap mentett valamit localStorage-be, azt használjuk
    function applyThemeFromLocalEarly(){
      const t = getThemeFromLocal();
      if(t === 'light' || t === 'dark'){
        applyTheme(t);
      }else{
        // default marad a CSS szerinti (dark)
        applyTheme('dark');
      }
    }

    // ✅ már a script elején ráhúzzuk (minél kevesebb "villanás")
    applyThemeFromLocalEarly();

    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }

    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }

    function getMonthNav(y,m,dir){
      const d = new Date(Number(y), Number(m)-1, 15, 12, 0, 0);
      d.setMonth(d.getMonth()+dir);
      return { y:d.getFullYear(), m:d.getMonth()+1 };
    }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const [h,m] = String(hhmm).slice(0,5).split(':').map(Number);
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.max(0, Number(mins)||0);
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function minsToHColonMM(mins){
      const abs = Math.abs(Math.round(Number(mins||0)));
      const h = Math.floor(abs/60);
      const mm = abs%60;
      return `${h}:${String(mm).padStart(2,'0')}`;
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' }
      });
      return supabase;
    }

    function buildTimeOptionsWithGap(selectEl, step=15, max=24*60, blankAfterHHMM=null){
      selectEl.innerHTML = '';
      let gapIndex = -1;

      for(let t=0; t<=max; t+=step){
        const h = Math.floor(t/60);
        const mm = t%60;
        const val = `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;

        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);

        if(blankAfterHHMM && val === blankAfterHHMM){
          const optGapBlank = document.createElement('option');
          optGapBlank.value = '';
          optGapBlank.textContent = '';
          selectEl.appendChild(optGapBlank);
          gapIndex = selectEl.options.length - 1;
        }
      }

      if(gapIndex < 0){
        const optBlank = document.createElement('option');
        optBlank.value = '';
        optBlank.textContent = '';
        selectEl.insertBefore(optBlank, selectEl.firstChild);
        gapIndex = 0;
      }

      selectEl.dataset.gapBlankIndex = String(gapIndex);
      selectEl.selectedIndex = gapIndex;
    }

    function buildFlexMinutesOptionsWithGap(selectEl, step=15, max=8*60, blankAfterMinutes=null){
      selectEl.innerHTML = '';
      let gapIndex = -1;

      for(let t=0; t<=max; t+=step){
        const opt = document.createElement('option');
        opt.value = String(t);
        opt.textContent = minsToHHMM(t);
        selectEl.appendChild(opt);

        if(blankAfterMinutes != null && t === blankAfterMinutes){
          const optGapBlank = document.createElement('option');
          optGapBlank.value = '';
          optGapBlank.textContent = '';
          selectEl.appendChild(optGapBlank);
          gapIndex = selectEl.options.length - 1;
        }
      }

      if(gapIndex < 0){
        const optBlank = document.createElement('option');
        optBlank.value = '';
        optBlank.textContent = '';
        selectEl.insertBefore(optBlank, selectEl.firstChild);
        gapIndex = 0;
      }

      selectEl.dataset.gapBlankIndex = String(gapIndex);
      selectEl.selectedIndex = gapIndex;
    }

    function setSelectToGapBlank(selectEl){
      const idx = Number(selectEl.dataset.gapBlankIndex || 0);
      if(Number.isFinite(idx) && selectEl.options && selectEl.options[idx]){
        selectEl.selectedIndex = idx;
      }else{
        selectEl.value = '';
      }
    }

    // ===== quick pairs: load (db + local fallback) =====
    function localKey(){
      return `kultora_quickpairs_${currentUserId || 'anon'}`;
    }

    function loadQuickPairsFromLocal(){
      try{
        const raw = localStorage.getItem(localKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(_){
        return [];
      }
    }

    function saveQuickPairsToLocal(){
      try{
        localStorage.setItem(localKey(), JSON.stringify(quickPairs.slice(0,3).map(p=>({arrival:p.arrival, departure:p.departure}))));
      }catch(_){}
    }

    async function loadQuickPairs(){
      // local azonnal
      quickPairs = loadQuickPairsFromLocal()
        .map(p => ({ arrival:String(p?.arrival||'').slice(0,5), departure:String(p?.departure||'').slice(0,5) }))
        .filter(p => p.arrival && p.departure)
        .slice(0,3);

      if(!currentUserId) return;

      try{
        const { data, error } = await supabase
          .from('user_quick_pairs')
          .select('id,arrival,departure,created_at')
          .eq('user_id', currentUserId)
          .order('created_at', { ascending:true });

        if(error) throw error;

        const fromDb = (data||[])
          .map(r => ({ arrival:String(r.arrival||'').slice(0,5), departure:String(r.departure||'').slice(0,5), id:r.id }))
          .filter(p => p.arrival && p.departure)
          .slice(0,3);

        if(fromDb.length){
          quickPairs = fromDb.map(p => ({ arrival:p.arrival, departure:p.departure, id:p.id }));
          saveQuickPairsToLocal();
        }
      }catch(_e){
        // marad a local
      }
    }

    // ===== ✅ quick buttons render (no title, no colored container) =====
    function renderQuickPairsRow(){
      const row = $('quickPairsRow');
      row.innerHTML = '';

      if(!quickPairs.length){
        row.classList.add('hidden');
        return;
      }

      quickPairs.slice(0,3).forEach((p, idx)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'qpBtn';
        btn.textContent = `${p.arrival}–${p.departure}`;
        btn.addEventListener('click', async ()=>{
          await applyQuickPairAndSave(idx);
        });
        row.appendChild(btn);
      });

      row.classList.remove('hidden');
      updateQuickButtonsEnabledState();
    }

    function updateQuickButtonsEnabledState(){
      const row = $('quickPairsRow');
      const disabled =
        !editingDate ||
        !!$('sickChk').checked ||
        !!$('arrSel').disabled ||
        !!$('depSel').disabled;

      Array.from(row.querySelectorAll('button')).forEach(b=>{
        b.disabled = disabled;
      });
    }

    async function applyQuickPairAndSave(idx){
      const iso = editingDate;
      if(!iso) return;

      const p = quickPairs[idx];
      if(!p) return;

      if($('sickChk').checked){
        $('sickChk').checked = false;
      }

      const a = String(p.arrival||'').slice(0,5);
      const d = String(p.departure||'').slice(0,5);

      const hasA = Array.from($('arrSel').options).some(o=>o.value===a);
      const hasD = Array.from($('depSel').options).some(o=>o.value===d);

      if(!hasA || !hasD){
        toast('Gyorsgomb időpontja nem választható.');
        return;
      }

      $('arrSel').value = a;
      $('depSel').value = d;
      setSelectToGapBlank($('flexSel'));

      onFormChanged();
      if(!validateEditForm()) return;

      try{
        await saveCurrentEdit();

        // ✅ zárás és vissza a naptárra
        closeEdit();
        await loadMonth();

        toast('Mentve.');
      }catch(e){
        toast('Mentés hiba: ' + (e?.message||String(e)));
      }
    }

    function tileClass(row){
      const iso = row.date;
      const isHol = (!row.is_workday && !!row.holiday_name);
      if(isHol) return 'tile holiday';
      if(!!row.special_workday) return 'tile workSaturday';
      if(isWeekendISO(iso)) return 'tile weekend';
      if(!row.is_workday) return 'tile rest';
      return 'tile';
    }

    function updateJumpButton(){
      const today = getTodayISO();
      const ty = Number(today.slice(0,4));
      const tm = Number(today.slice(5,7));
      const show = !(curYear === ty && curMonth === tm);
      $('jumpTodayBtn').classList.toggle('hidden', !show);
    }

    function isWorkdayForVacation(iso){
      const cal = yearCalMap.get(iso);
      if(!cal) return false;
      const isSpecial = !!cal.special_workday;
      const isNonWork = (!cal.is_workday && !isSpecial);
      if(isNonWork) return false;
      if(!cal.is_workday) return false;
      return true;
    }

    function isSickAllowedOnDay(iso){
      const cal = yearCalMap.get(iso);
      if(!cal) return false;

      const isSpecial = !!cal.special_workday;
      const isNonWork = (!cal.is_workday && !isSpecial);
      if(isNonWork) return false;

      if(!!cal.holiday_name) return false;

      return true;
    }

    function renderGrid(){
      const grid = $('grid');
      grid.innerHTML = '';

      const firstIso = monthRows[0]?.date;
      if(!firstIso) return;

      const todayIso = getTodayISO();

      const firstDate = new Date(firstIso+'T12:00:00');
      let wd = firstDate.getDay();
      wd = wd===0 ? 7 : wd;
      const offset = wd-1;

      for(let i=0;i<42;i++){
        if(i<offset || (i-offset)>=monthRows.length){
          const empty = document.createElement('div');
          empty.className = 'tile rest';
          empty.style.opacity = '.15';
          grid.appendChild(empty);
          continue;
        }

        const row = monthRows[i-offset];
        const iso = row.date;

        const tile = document.createElement('div');
        tile.className = tileClass(row);

        if(iso===todayIso) tile.classList.add('todayFill');

        const top = document.createElement('div');
        top.className = 'tTop';
        const dn = document.createElement('div');
        dn.className = 'tDay';
        dn.textContent = String(Number(iso.slice(8,10)));
        top.appendChild(dn);

        const lines = document.createElement('div');
        lines.className = 'lines';

        const l1 = document.createElement('div'); l1.className='line';
        const l2 = document.createElement('div'); l2.className='line';
        const l3 = document.createElement('div'); l3.className='line';

        const entry = entriesByDate.get(iso);

        const arr = entry?.arrival ? String(entry.arrival).slice(0,5) : '';
        const dep = entry?.departure ? String(entry.departure).slice(0,5) : '';
        const flexMin = Number(entry?.flex_minutes || 0);
        const isVac = !!entry?.is_vacation;
        const isSick = !!entry?.is_sick;

        if(isVac){
          tile.classList.remove('holiday','weekend','rest','workSaturday','sick');
          tile.classList.add('vac');
        }

        if(isSick){
          tile.classList.remove('holiday','weekend','rest','workSaturday','vac');
          tile.classList.add('sick');
        }

        if(arr) l1.textContent = arr;
        if(dep) l2.textContent = dep;

        if(isSick){
          l3.textContent = 'Beteg';
          l3.classList.add('black');
        }else if(flexMin > 0){
          l3.textContent = minsToHHMM(flexMin);
          if(iso === todayIso){
            l3.classList.add('black');
          }else{
            l3.classList.add('red');
          }
        }else if(isVac){
          l3.textContent = 'Szabi';
          l3.classList.add('black');
        }else if(row.holiday_name && !entry){
          l3.textContent = row.holiday_name;
          l3.classList.add('black');
        }else{
          l3.textContent = '';
        }

        lines.appendChild(l1); lines.appendChild(l2); lines.appendChild(l3);
        tile.appendChild(top);
        tile.appendChild(lines);

        tile.addEventListener('click', ()=>openEdit(iso, row));
        grid.appendChild(tile);
      }
    }

    function calcVacationRemaining(){
      const remain = (vacTotalEntitlement || 0) - (yearVacUsed || 0);
      return remain;
    }

    // ✅ összesítő-féle vacTakenToToday (csak munkanapos szabi <= ma)
    function calcVacationTakenToToday(){
      const today = getTodayISO();
      let taken = 0;

      for(const [d, e] of yearEntryMap.entries()){
        if(d > today) continue;
        if(e?.is_vacation && isWorkdayForVacation(d)){
          taken++;
        }
      }
      return taken;
    }

    function applyVacationAvailability(entry){
      const remaining = calcVacationRemaining();
      const alreadyVac = !!entry?.is_vacation;
      const shouldDisable = (!alreadyVac && remaining <= 0);

      $('vacChk').disabled = shouldDisable;
      $('noVacMsg').classList.toggle('hidden', !shouldDisable);
      $('vacChk').style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
    }

    function applySickAvailability(iso, entry){
      const allowedByDay = isSickAllowedOnDay(iso);
      const alreadySick = !!entry?.is_sick;

      const shouldDisable = (!alreadySick && !allowedByDay);
      $('sickChk').disabled = shouldDisable;
      $('noSickMsg').classList.toggle('hidden', !(shouldDisable && !alreadySick));
      $('sickChk').style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
    }

    function setWorkControlsEnabled(enabled){
      $('arrSel').disabled = !enabled;
      $('depSel').disabled = !enabled;
      $('flexSel').disabled = !enabled;

      $('arrLbl').classList.toggle('labelDisabled', $('arrSel').disabled);
      $('depLbl').classList.toggle('labelDisabled', $('depSel').disabled);
      $('flexLbl').classList.toggle('labelDisabled', $('flexSel').disabled);
    }

    function calcBalanceMinToToday(){
      const today = getTodayISO();

      const expPerDay = Number(profile?.daily_expected_minutes ?? 480);
      const carry = Number(profile?.flex_carryover_minutes || 0);
      const bonus = Number(profile?.flex_bonus_minutes || 0);

      let expectedTotal = 0;
      let fulfilledTotal = 0;

      const calRows = Array.from(yearCalMap.values()).sort((a,b)=>a.date.localeCompare(b.date));

      for(const cal of calRows){
        const iso = cal.date;
        if(iso > today) break;

        const isSpecial = !!cal.special_workday;
        const isExpectedDay = !!cal.is_workday || isSpecial;

        const entry = yearEntryMap.get(iso);

        if(iso === today){
          const meaningful = !!(entry && (
            (entry.arrival && entry.departure) ||
            (Number(entry.flex_minutes||0) > 0) ||
            !!entry.is_vacation ||
            !!entry.is_sick ||
            (!!entry.note && String(entry.note).trim().length > 0)
          ));
          if(!meaningful) continue;
        }

        const expected = isExpectedDay ? expPerDay : 0;
        expectedTotal += expected;

        let fulfilled = 0;

        if(entry){
          const vac = !!entry.is_vacation;
          const sick = !!entry.is_sick;

          if((vac || sick) && isExpectedDay){
            fulfilled += expected;
          }

          let worked = 0;
          if(entry.arrival && entry.departure){
            const inM = hhmmToMins(String(entry.arrival).slice(0,5));
            const outM = hhmmToMins(String(entry.departure).slice(0,5));
            if(inM != null && outM != null && outM >= inM){
              worked = outM - inM;
            }
          }
          const flexM = Math.max(0, Number(entry.flex_minutes || 0));
          worked = Math.max(0, worked - flexM);

          const isDouble = (!isExpectedDay) || (vac && worked > 0);
          const mult = isDouble ? 2 : 1;

          fulfilled += worked * mult;
        }

        fulfilledTotal += fulfilled;
      }

      return (carry + bonus) + (fulfilledTotal - expectedTotal);
    }

    function updateStatusBar(){
      const vacEl = $('statVac');
      const balEl = $('statBal');
      if(!vacEl || !balEl) return;
      // ✅ statVac = összesítő-féle X (csak a mai napig kiírt szabik)
      const vacTakenToToday = calcVacationTakenToToday();
      const vacTotal = (vacTotalEntitlement || 0); // = vacEnt + vacCarry
      const X = Math.max(0, vacTotal - vacTakenToToday);
      vacEl.textContent = String(Math.round(X));

      const balMin = calcBalanceMinToToday();
      const dayBase = Number(profile?.daily_expected_minutes ?? 480) || 480;
      const days = Math.round(Math.abs(balMin) / dayBase);

      const txt = (balMin === 0)
        ? `0:00 (${days})`
        : `${balMin > 0 ? '+' : '-'}${minsToHColonMM(balMin)} (${days})`;

      const el = balEl;
      el.textContent = txt;

      el.classList.remove('green','red');
      if(balMin > 0) el.classList.add('green');
      else if(balMin < 0) el.classList.add('red');
    }

    function getCurrentFormState(){
      return {
        arrival: $('arrSel').value || '',
        departure: $('depSel').value || '',
        flex: $('flexSel').value || '',
        vac: !!$('vacChk').checked,
        sick: !!$('sickChk').checked,
        note: ($('noteTxt').value || '')
      };
    }

    function statesEqual(a,b){
      return (
        (a.arrival||'') === (b.arrival||'') &&
        (a.departure||'') === (b.departure||'') &&
        (a.flex||'') === (b.flex||'') &&
        (!!a.vac) === (!!b.vac) &&
        (!!a.sick) === (!!b.sick) &&
        (a.note||'') === (b.note||'')
      );
    }

    function updateSaveButton(){
      if(!initialEditState){
        formDirty = false;
      }else{
        formDirty = !statesEqual(initialEditState, getCurrentFormState());
      }

      $('saveBtn').textContent = formDirty ? 'Mentés' : 'Vissza';
      $('saveBtn').disabled = (formDirty && formInvalid);
    }

    function validateEditForm(){
      if($('sickChk').checked){
        $('editErr').classList.add('hidden');
        formInvalid = false;
        updateSaveButton();
        return true;
      }

      const inV = $('arrSel').value;
      const outV = $('depSel').value;

      const inWrap = $('arrSel').parentElement;
      const outWrap = $('depSel').parentElement;

      if(inV && outV){
        const inM = hhmmToMins(inV);
        const outM = hhmmToMins(outV);
        if(outM < inM){
          $('editErr').textContent = 'Hiba: Távozás nem lehet korábbi, mint Érkezés!';
          $('editErr').classList.remove('hidden');
          inWrap.classList.add('invalid');
          outWrap.classList.add('invalid');
          formInvalid = true;
          updateSaveButton();
          return false;
        }
      }

      $('editErr').classList.add('hidden');
      inWrap.classList.remove('invalid');
      outWrap.classList.remove('invalid');
      formInvalid = false;
      updateSaveButton();
      return true;
    }

    function openEdit(iso, calRow){
      editingDate = iso;
      editingCalRow = calRow;

      const todayIso = getTodayISO();
      const isFuture = iso > todayIso;

      $('editDate').textContent = iso.replaceAll('-', '.');
      $('editErr').classList.add('hidden');
      formInvalid = false;

      const entry = entriesByDate.get(iso) || {};

      const arr = entry.arrival ? String(entry.arrival).slice(0,5) : '';
      const dep = entry.departure ? String(entry.departure).slice(0,5) : '';
      const flexMin = Number(entry.flex_minutes || 0);
      const flexVal = flexMin > 0 ? String(flexMin) : '';

      if(arr) $('arrSel').value = arr; else setSelectToGapBlank($('arrSel'));
      if(dep) $('depSel').value = dep; else setSelectToGapBlank($('depSel'));
      if(flexVal) $('flexSel').value = flexVal; else setSelectToGapBlank($('flexSel'));

      $('vacChk').checked = !!entry.is_vacation;
      $('sickChk').checked = !!entry.is_sick;
      $('noteTxt').value = entry.note ? String(entry.note) : '';

      const isSpecial = !!calRow.special_workday;
      const isNonWork = (!calRow.is_workday && !isSpecial);
      const isWeekend = isWeekendISO(iso);
      const disFlexByDayType = (!isSpecial) && (isWeekend || isNonWork);

      $('arrSel').disabled = isFuture;
      $('depSel').disabled = isFuture;
      $('flexSel').disabled = isFuture ? true : disFlexByDayType;

      $('arrLbl').classList.toggle('labelDisabled', $('arrSel').disabled);
      $('depLbl').classList.toggle('labelDisabled', $('depSel').disabled);
      $('flexLbl').classList.toggle('labelDisabled', $('flexSel').disabled);

      applyVacationAvailability(entry);
      applySickAvailability(iso, entry);

      if($('sickChk').checked){
        setSelectToGapBlank($('arrSel'));
        setSelectToGapBlank($('depSel'));
        setSelectToGapBlank($('flexSel'));
        setWorkControlsEnabled(false);
      }

      // ✅ quick buttons kirajzolás
      renderQuickPairsRow();

      initialEditState = getCurrentFormState();
      updateSaveButton();

      $('modalBackdrop').classList.remove('hidden');
      validateEditForm();
      updateQuickButtonsEnabledState();
    }

    function closeEdit(){
      $('modalBackdrop').classList.add('hidden');
      editingDate = null;
      editingCalRow = null;
      initialEditState = null;
      formDirty = false;
      formInvalid = false;
      $('noVacMsg').classList.add('hidden');
      $('noSickMsg').classList.add('hidden');
      $('quickPairsRow').classList.add('hidden');
    }

    function clearEditForm(){
      setSelectToGapBlank($('arrSel'));
      setSelectToGapBlank($('depSel'));
      setSelectToGapBlank($('flexSel'));
      $('vacChk').checked = false;
      $('sickChk').checked = false;
      $('noteTxt').value = '';

      applyVacationAvailability({ is_vacation:false });
      applySickAvailability(editingDate, { is_sick:false });

      if(editingDate && editingCalRow){
        const iso = editingDate;
        const calRow = editingCalRow;

        const todayIso = getTodayISO();
        const isFuture = iso > todayIso;

        const isSpecial = !!calRow.special_workday;
        const isNonWork = (!calRow.is_workday && !isSpecial);
        const isWeekend = isWeekendISO(iso);
        const disFlexByDayType = (!isSpecial) && (isWeekend || isNonWork);

        $('arrSel').disabled = isFuture;
        $('depSel').disabled = isFuture;
        $('flexSel').disabled = isFuture ? true : disFlexByDayType;

        $('arrLbl').classList.toggle('labelDisabled', $('arrSel').disabled);
        $('depLbl').classList.toggle('labelDisabled', $('depSel').disabled);
        $('flexLbl').classList.toggle('labelDisabled', $('flexSel').disabled);
      }

      validateEditForm();
      updateSaveButton();
      updateQuickButtonsEnabledState();
    }

    function isPayloadEmpty(payload){
      return (
        !payload.arrival &&
        !payload.departure &&
        (payload.flex_minutes === 0) &&
        !payload.is_vacation &&
        !payload.is_sick &&
        (!payload.note || payload.note.length === 0)
      );
    }

    async function refreshYearCachesAfterSave(iso, newEntryOrNull){
      if(newEntryOrNull){
        yearEntryMap.set(iso, newEntryOrNull);
      }else{
        yearEntryMap.delete(iso);
      }

      yearVacUsed = 0;
      for(const [d, e] of yearEntryMap.entries()){
        if(e?.is_vacation && isWorkdayForVacation(d)){
          yearVacUsed++;
        }
      }

      updateStatusBar();
    }

    async function saveCurrentEdit(){
      const iso = editingDate;
      if(!iso) return;

      const before = entriesByDate.get(iso) || null;
      const beforeVac = !!before?.is_vacation;

      const wantSick = !!$('sickChk').checked;
      if(wantSick && !isSickAllowedOnDay(iso)){
        throw new Error('Betegállomány hétvégén vagy ünnepnapon nem jelölhető.');
      }

      const sickMode = wantSick;

      const payload = {
        date: iso,
        arrival: sickMode ? null : ($('arrSel').value || null),
        departure: sickMode ? null : ($('depSel').value || null),
        flex_minutes: sickMode ? 0 : ($('flexSel').value ? Number($('flexSel').value) : 0),
        is_vacation: sickMode ? false : $('vacChk').checked,
        is_sick: sickMode,
        note: ($('noteTxt').value || '').trim()
      };

      if(payload.is_vacation && !beforeVac){
        const remaining = calcVacationRemaining();
        if(remaining <= 0){
          throw new Error('Nincs már kiírható szabid.');
        }
      }

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      if(!uid) throw new Error('Nincs user session.');

      const { error } = await supabase
        .from('entries')
        .upsert({ user_id: uid, ...payload }, { onConflict: 'user_id,date' });
      if(error) throw error;

      const empty = isPayloadEmpty(payload);

      if(empty){
        entriesByDate.delete(iso);
      }else{
        const merged = { user_id: uid, ...payload };
        entriesByDate.set(iso, merged);
      }

      await refreshYearCachesAfterSave(iso, empty ? null : entriesByDate.get(iso));
    }

    async function loadProfile(){
      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      currentUserId = uid;
      if(!uid) return null;

      const { data, error } = await supabase
        .from('profiles')
        .select('display_name,email,role,vacation_entitlement_days,vacation_carryover_days,daily_expected_minutes,flex_carryover_minutes,flex_bonus_minutes')
        .eq('user_id', uid)
        .maybeSingle();

      if(error) throw error;

      profile = data || {
        display_name: u.user.email,
        email: u.user.email,
        role: 'user',
        vacation_entitlement_days:0,
        vacation_carryover_days:0,
        daily_expected_minutes:480,
        flex_carryover_minutes:0,
        flex_bonus_minutes:0
      };

      $('userName').textContent = profile.display_name || profile.email || '';

      vacTotalEntitlement =
        Number(profile.vacation_entitlement_days || 0) +
        Number(profile.vacation_carryover_days || 0);

      const role = String(profile.role || 'user');
      if(role === 'admin' || role === 'manager'){
        $('settingsBtn').classList.remove('hidden');
      }else{
        $('settingsBtn').classList.add('hidden');
      }

      await loadQuickPairs();
    }

    async function loadYearCalendar(){
      const { data: days, error } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', curYear)
        .order('date', { ascending:true });
      if(error) throw error;

      yearCalMap = new Map();
      (days||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        yearCalMap.set(iso, { ...r, date: iso });
      });
    }

    async function loadYearEntries(){
      const start = `${curYear}-01-01`;
      const end = `${curYear+1}-01-01`;

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      if(!uid) throw new Error('Nincs user session.');

      const { data: ents, error } = await supabase
        .from('entries')
        .select('user_id,date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });

      if(error) throw error;

      yearEntryMap = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        yearEntryMap.set(iso, { ...r, date: iso });
      });

      yearVacUsed = 0;
      for(const [d, e] of yearEntryMap.entries()){
        if(e?.is_vacation && isWorkdayForVacation(d)){
          yearVacUsed++;
        }
      }
    }

    async function loadMonth(){
      const start = `${curYear}-${String(curMonth).padStart(2,'0')}-01`;
      const end = curMonth===12 ? `${curYear+1}-01-01` : `${curYear}-${String(curMonth+1).padStart(2,'0')}-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', curYear)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });
      if(e1) throw e1;

      monthRows = (days || []).map(r => ({ ...r, date: normalizeIsoDate(r.date) }));

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('user_id,date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });
      if(e2) throw e2;

      entriesByDate = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        entriesByDate.set(iso, { ...r, date: iso });
      });

      $('monthTitle').textContent = `${curYear} ${huMonthName(curMonth)}`;
      renderGrid();
      updateJumpButton();
    }

    function applyInitialMonthFromQueryOrToday(){
      const today = getTodayISO();
      const ty = Number(today.slice(0,4));
      const tm = Number(today.slice(5,7));

      const p = new URLSearchParams(location.search);
      const qy = Number(p.get('y'));
      const qm = Number(p.get('m'));

      if(Number.isFinite(qy) && Number.isFinite(qm) && qy === 2026 && qm >= 1 && qm <= 12){
        curYear = qy;
        curMonth = qm;
      }else{
        curYear = ty;
        curMonth = tm;
      }
    }

    function onFormChanged(){
      const iso = editingDate;

      if(iso){
        const entry = entriesByDate.get(iso) || {};
        const alreadyVac = !!entry.is_vacation;

        if($('vacChk').checked && !alreadyVac){
          const remaining = calcVacationRemaining();
          if(remaining <= 0){
            $('vacChk').checked = false;
            $('vacChk').disabled = true;
            $('noVacMsg').classList.remove('hidden');
            toast('Nincs már kiírható szabid.');
          }
        }

        if($('sickChk').checked){
          if(!isSickAllowedOnDay(iso)){
            $('sickChk').checked = false;
            toast('Betegállomány hétvégén vagy ünnepnapon nem jelölhető.');
          }else{
            setSelectToGapBlank($('arrSel'));
            setSelectToGapBlank($('depSel'));
            setSelectToGapBlank($('flexSel'));
            setWorkControlsEnabled(false);

            if($('vacChk').checked){
              $('vacChk').checked = false;
            }
          }
        }else{
          if(editingCalRow){
            const calRow = editingCalRow;

            const todayIso = getTodayISO();
            const isFuture = iso > todayIso;

            const isSpecial = !!calRow.special_workday;
            const isNonWork = (!calRow.is_workday && !isSpecial);
            const isWeekend = isWeekendISO(iso);
            const disFlexByDayType = (!isSpecial) && (isWeekend || isNonWork);

            $('arrSel').disabled = isFuture;
            $('depSel').disabled = isFuture;
            $('flexSel').disabled = isFuture ? true : disFlexByDayType;

            $('arrLbl').classList.toggle('labelDisabled', $('arrSel').disabled);
            $('depLbl').classList.toggle('labelDisabled', $('depSel').disabled);
            $('flexLbl').classList.toggle('labelDisabled', $('flexSel').disabled);
          }
        }

        applySickAvailability(iso, entry);
      }

      validateEditForm();
      updateSaveButton();
      updateQuickButtonsEnabledState();
    }

    async function boot(){
      await ensureSupabase();

      const { data } = await supabase.auth.getSession();
      if(!data.session){
        location.replace('/index.html?v=' + Date.now());
        return;
      }

      await loadProfile();

      await loadYearCalendar();
      await loadYearEntries();
      updateStatusBar();

      buildTimeOptionsWithGap($('arrSel'), 15, 24*60, '08:00');
      buildTimeOptionsWithGap($('depSel'), 15, 24*60, '16:00');
      buildFlexMinutesOptionsWithGap($('flexSel'), 15, 8*60, 240);

      applyInitialMonthFromQueryOrToday();
      await loadMonth();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      $('logoutBtn').addEventListener('click', async ()=>{
        try{
          await ensureSupabase();
          await supabase.auth.signOut();
        }catch(_){}
        location.replace('/index.html?v=' + Date.now());
      });

      $('sumBtn').addEventListener('click', ()=>{
        location.href = '/adatlap.html?v=' + Date.now();
      });

      $('settingsBtn').addEventListener('click', ()=>{
        location.href = '/manager.html?v=' + Date.now();
      });

      $('prevBtn').addEventListener('click', async ()=>{
        const nav = getMonthNav(curYear, curMonth, -1);
        if(nav.y!==2026) return;
        curYear = nav.y; curMonth = nav.m;
        await loadMonth();
      });
      $('nextBtn').addEventListener('click', async ()=>{
        const nav = getMonthNav(curYear, curMonth, +1);
        if(nav.y!==2026) return;
        curYear = nav.y; curMonth = nav.m;
        await loadMonth();
      });

      $('jumpTodayBtn').addEventListener('click', async ()=>{
        const today = getTodayISO();
        curYear = Number(today.slice(0,4));
        curMonth = Number(today.slice(5,7));
        await loadMonth();
      });

      $('modalBackdrop').addEventListener('click', (e)=>{
        if(e.target === $('modalBackdrop')) closeEdit();
      });

      $('arrSel').addEventListener('change', onFormChanged);
      $('depSel').addEventListener('change', onFormChanged);
      $('flexSel').addEventListener('change', onFormChanged);
      $('vacChk').addEventListener('change', onFormChanged);
      $('sickChk').addEventListener('change', onFormChanged);
      $('noteTxt').addEventListener('input', onFormChanged);

      $('delBtn').addEventListener('click', ()=>clearEditForm());

      $('saveBtn').addEventListener('click', async ()=>{
        if(!formDirty){
          closeEdit();
          return;
        }
        if(!validateEditForm()) return;

        try{
          await saveCurrentEdit();
          closeEdit();
          await loadMonth();
        }catch(e){
          toast('Mentés hiba: ' + (e?.message||String(e)));
        }
      });

      boot().catch(e=>toast('Indulási hiba: ' + (e?.message||String(e))));
    });
  })();
  </script>
</body>
</html>
