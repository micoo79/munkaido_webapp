<!-- app.html -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Munkaidő</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#777b81;
      --zold:#1ecb5b;
      --piros:#ff3b30;
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* ---------- HEADER ---------- */
    .header{
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:transparent;
    }

    .user-block{
      display:flex;
      align-items:center;
      gap:6px;
      min-width:0;
    }

    .user-name{
      font-weight:700;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:48vw;
    }

    .nav-container{
      display:flex;
      gap:0;
      align-items:center;
    }

    .nav-item{
      border:0;
      background:transparent;
      color:var(--text);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      width:44px;
      height:52px;
      position:relative;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
      padding:0;
    }

    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      transition:color 0.2s ease;
      line-height:1;
    }

    .menu-label{
      font-size:10px;
      position:absolute;
      bottom:4px;
      left:50%;
      transform:translateX(-50%);
      white-space:nowrap;
      pointer-events:none;
      transition:opacity 0.2s ease, color 0.2s ease;
    }

    /* Kilépés: ikon fehér, felirat is fehér (kérés) */
    .logout-item .material-symbols-outlined{ color:var(--text); opacity:1; }
    .logout-item .menu-label{ color:var(--text); opacity:1; }

    /* Összesítő: felirat alapból látszik, hoverre narancs */
    .sum-item .menu-label{opacity:1; color:var(--text);}
    .sum-item:hover .material-symbols-outlined,
    .sum-item:hover .menu-label{color:var(--accent);}

    /* Beállítások: felirat alapból rejtett, hoverre jelenik meg + narancs */
    .settings-item .menu-label{opacity:0;}
    .settings-item:hover .material-symbols-outlined,
    .settings-item:hover .menu-label{
      opacity:1;
      color:var(--accent);
    }

    /* ---------- MAIN ---------- */
    .wrap{max-width:900px; margin:0 auto; padding:0px;}
    .card{background:var(--panel); border:0; border-radius:16px; padding:6px;}
    .hidden{display:none !important;}

    /* Calendar layout */
    .pager{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:20px 0px 20px;
    }
    .arrow{
      width:9%;
      min-width:64px;
      height:36px;
      display:flex; align-items:center; justify-content:center;
      background:#1ecb5b;
      border-radius:0px;
      cursor:pointer;
      user-select:none;
      font-size:32px;
      transition:background 0.2s;
    }
    .arrow:hover{background:#1ecb5b;}
    .spacer{width:14%;}
    .title{width:42%; text-align:center; font-size:1rem; font-weight:800;}

    .dow{
      height:1vh; min-height:20px;
      display:grid; grid-template-columns:repeat(7,1fr); gap:8px;
      align-items:center; margin-top:4px;
    }
    .dow div{
      text-align:center;
      font-size:16px;
      font-weight:600;
    }

    .gridWrap{height:60vh; min-height:360px; margin-top:8px;}
    .grid{
      height:100%;
      display:grid;
      grid-template-columns:repeat(7,1fr);
      grid-template-rows:repeat(6,1fr);
      gap:3px;
    }

    .tile{
      background:var(--work);
      border-radius:0px;
      display:flex;
      flex-direction:column;
      overflow:hidden;
      cursor:pointer;
      position:relative;
      border:0;
      padding:0.2rem;
      transition:transform 0.2s;
    }
    .tile:hover{transform:scale(1.05);}
    .tile:active{transform:scale(0.95);}

    .tile.rest{background:var(--rest); opacity:1;}
    .tile.weekend{background:var(--weekend);}
    .tile.holiday{background:var(--holiday);}
    .tile.vac{background:var(--vac);}
    .tile.workSaturday{background:var(--work); border:0;}
    .tile.todayFill{background:var(--accent) !important; color:#111;}

    .tTop{
      height:auto;
      display:flex;
      align-items:flex-start;
      justify-content:flex-start;
      padding:0;
      margin-bottom:0.25rem;
    }
    .tDay{
      font-size:1.2rem;
      font-weight:900;
      line-height:1;
      text-align:left;
    }

    .lines{
      flex:1;
      display:flex;
      flex-direction:column;
      padding:0;
      gap:0;
      justify-content:flex-start;
    }
    .line{
      font-size:0.75rem;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-weight:500;
    }

    .tile .tDay{color:#000;}
    .tile .line{color:#374151;}

    .tile.weekend .tDay{color:#fff;}
    .tile.weekend .line{color:#e5e7eb;}

    .tile.rest .tDay{color:#9ca3af;}
    .tile.rest .line{color:#9ca3af;}

    .tile.todayFill .tDay{color:#111;}
    .tile.todayFill .line{color:#fff;}

    .line.red{color:var(--piros) !important;}
    .line.black{color:#111 !important;}

    /* Jump today button */
    .jumpWrap{padding:10px 0 2px;}
    .jumpBtn{
      width:100%;
      height:42px;
      border:0;
      background:var(--zold);
      color:#111;
      font-size:1rem;
      font-weight:900;
      cursor:pointer;
      border-radius:6px;
    }

    /* Toast */
    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:20px;
      z-index:99;
    }

    /* Edit modal */
    .modalBackdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:flex; align-items:center; justify-content:center;
      padding:18px; z-index:50;
    }
    .modal{
      width:min(900px,100%);
      background:#52525b;
      border-radius:20px;
      padding:18px;
      border:1px solid rgba(255,255,255,.10);
    }
    .modalHeader{font-size:34px; font-weight:800; margin:0 0 8px 0;}
    .row{display:flex; align-items:center; justify-content:space-between; gap:1px; flex-wrap:wrap;}
    .row label{font-size:20px; font-weight:400; min-width:140px;}
    .row .ctrl{flex:1; min-width:180px;}
    select, textarea{
      width:60%;
      padding:4px 4px;
      border-radius:0px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      color:#111;
      font-size:0.7rem;
      outline:none;
    }
    textarea{min-height:90px; resize:none;}
    .gap75{height:3px;}
    .gap30{height:30px;}
    .btnRow{display:flex; gap:12px; margin-top:12px;}
    .btn{
      border:0; border-radius:6px;
      padding:0px 0px;
      font-size:1rem;
      cursor:pointer;
      flex:1;
      height:34px;
    }
    .btn.danger{background:#c9cbd1; color:#111; font-weight:900;}
    .btn.mentes{background:#1ecb5b; color:#111; font-weight:900;}

    .errBig{font-size:22px; color:#ff3b30; margin-top:10px; font-weight:900;}
    .invalid select{background:#ffd1d1 !important; border:3px solid #ff3b30 !important;}

    @media (max-width:520px){
      .title{font-size:1rem;}
      .dow div{font-size:14px;}
      .modalHeader{font-size:1.2rem;}
      .row label{font-size:1rem;}
      select, textarea{font-size:0.7rem;}
      .btn{font-size:1rem;}
      .tDay{font-size:1rem;}
      .line{font-size:0.625rem;}
      .nav-item{width:42px;}
      .user-name{max-width:52vw;}
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="user-block">
      <div id="userName" class="user-name"></div>
      <button id="logoutBtn" class="nav-item logout-item" type="button" aria-label="Kilépés">
        <span class="material-symbols-outlined">logout</span>
        <span class="menu-label">Kilépés</span>
      </button>
    </div>

    <nav class="nav-container">
      <button id="sumBtn" class="nav-item sum-item" type="button" aria-label="Összesítő">
        <span class="material-symbols-outlined">overview</span>
        <span class="menu-label">Összesítő</span>
      </button>

      <button id="settingsBtn" class="nav-item settings-item hidden" type="button" aria-label="Beállítások">
        <span class="material-symbols-outlined">settings</span>
        <span class="menu-label">Beállítások</span>
      </button>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="pager">
        <div id="prevBtn" class="arrow">‹</div>
        <div class="spacer"></div>
        <div id="monthTitle" class="title">2026 Április</div>
        <div class="spacer"></div>
        <div id="nextBtn" class="arrow">›</div>
      </div>

      <div class="dow">
        <div>H</div><div>K</div><div>SZ</div><div>CS</div><div>P</div><div>SZO</div><div>V</div>
      </div>

      <div class="gridWrap">
        <div id="grid" class="grid"></div>
      </div>

      <div id="jumpWrap" class="jumpWrap hidden">
        <button id="jumpTodayBtn" class="jumpBtn" type="button">Ugrás a mai napra</button>
      </div>
    </section>
  </main>

  <div id="modalBackdrop" class="modalBackdrop hidden">
    <div class="modal">
      <div id="editDate" class="modalHeader">2026.04.16</div>

      <div class="row" style="margin-top:10px;">
        <label>Érkezés</label>
        <div class="ctrl"><select id="arrSel"></select></div>
      </div>

      <div class="gap75"></div>

      <div class="row">
        <label>Távozás</label>
        <div class="ctrl"><select id="depSel"></select></div>
      </div>

      <div class="gap30"></div>

      <div class="row">
        <label>Csúsztatás</label>
        <div class="ctrl"><select id="flexSel"></select></div>
      </div>

      <div class="gap30"></div>

      <div class="row">
        <label>Szabi ezen a napon</label>
        <div class="ctrl" style="display:flex; align-items:center; justify-content:flex-start; gap:12px;">
          <input id="vacChk" type="checkbox" style="width:28px; height:28px; cursor:pointer;" />
        </div>
      </div>

      <div class="gap30"></div>

      <div class="row">
        <label>Megjegyzés</label>
        <div class="ctrl"><textarea id="noteTxt" placeholder="pl. csúsztatás oka, rendezvény neve, stb."></textarea></div>
      </div>

      <div id="editErr" class="errBig hidden"></div>

      <div class="btnRow">
        <button id="delBtn" class="btn danger" type="button">Törlés</button>
        <button id="saveBtn" class="btn mentes" type="button">Mentés</button>
      </div>
    </div>
  </div>

  <script>
  (() => {
    const $ = (id)=>document.getElementById(id);
    const toast = (t)=>{
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=t;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    };

    const DEV_TODAY = '2026-04-16';

    let supabase = null;
    let profile = null;

    let curYear = 2026;
    let curMonth = 4;

    let monthRows = [];
    let entriesByDate = new Map();

    let editingDate = null;
    let editingCalRow = null;

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }

    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }

    function getMonthNav(y,m,dir){
      const d = new Date(Number(y), Number(m)-1, 15, 12, 0, 0);
      d.setMonth(d.getMonth()+dir);
      return { y:d.getFullYear(), m:d.getMonth()+1 };
    }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const [h,m] = hhmm.split(':').map(Number);
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.max(0, Number(mins)||0);
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' }
      });
      return supabase;
    }

    function buildTimeOptions(selectEl, step=15, max=24*60){
      selectEl.innerHTML = '';
      const optBlank = document.createElement('option');
      optBlank.value = '';
      optBlank.textContent = '';
      selectEl.appendChild(optBlank);

      for(let t=0; t<=max; t+=step){
        const h = Math.floor(t/60);
        const mm = t%60;
        const val = `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;
        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);
      }
      selectEl.value = '';
    }

    function buildFlexMinutesOptions(selectEl, step=15, max=8*60){
      selectEl.innerHTML = '';
      const optBlank = document.createElement('option');
      optBlank.value = '';
      optBlank.textContent = '';
      selectEl.appendChild(optBlank);

      for(let t=0; t<=max; t+=step){
        const opt = document.createElement('option');
        opt.value = String(t);
        opt.textContent = minsToHHMM(t);
        selectEl.appendChild(opt);
      }
      selectEl.value = '';
    }

    function tileClass(row){
      const iso = row.date;
      const isHol = (!row.is_workday && !!row.holiday_name);
      if(isHol) return 'tile holiday';
      if(!!row.special_workday) return 'tile workSaturday';
      if(isWeekendISO(iso)) return 'tile weekend';
      if(!row.is_workday) return 'tile rest';
      return 'tile';
    }

    function normalizeIsoDate(d){
      return String(d).slice(0,10);
    }

    function renderJumpToday(){
      const today = getTodayISO();
      const ty = Number(today.slice(0,4));
      const tm = Number(today.slice(5,7));
      const show = (curYear !== ty) || (curMonth !== tm);
      $('jumpWrap').classList.toggle('hidden', !show);
    }

    function renderGrid(){
      const grid = $('grid');
      grid.innerHTML = '';

      const firstIso = monthRows[0]?.date;
      if(!firstIso) return;

      const firstDate = new Date(firstIso+'T12:00:00');
      let wd = firstDate.getDay();
      wd = wd===0 ? 7 : wd;
      const offset = wd-1;

      for(let i=0;i<42;i++){
        if(i<offset || (i-offset)>=monthRows.length){
          const empty = document.createElement('div');
          empty.className = 'tile rest';
          empty.style.opacity = '.15';
          grid.appendChild(empty);
          continue;
        }

        const row = monthRows[i-offset];
        const iso = row.date;

        const tile = document.createElement('div');
        tile.className = tileClass(row);

        if(iso===getTodayISO()) tile.classList.add('todayFill');

        const top = document.createElement('div');
        top.className = 'tTop';
        const dn = document.createElement('div');
        dn.className = 'tDay';
        dn.textContent = String(Number(iso.slice(8,10)));
        top.appendChild(dn);

        const lines = document.createElement('div');
        lines.className = 'lines';

        const l1 = document.createElement('div'); l1.className='line';
        const l2 = document.createElement('div'); l2.className='line';
        const l3 = document.createElement('div'); l3.className='line';

        const entry = entriesByDate.get(iso);

        const arr = entry?.arrival ? String(entry.arrival).slice(0,5) : '';
        const dep = entry?.departure ? String(entry.departure).slice(0,5) : '';
        const flexMin = Number(entry?.flex_minutes || 0);
        const isVac = !!entry?.is_vacation;

        if(isVac){
          tile.classList.remove('holiday','weekend','rest','workSaturday');
          tile.classList.add('vac');
        }

        if(arr) l1.textContent = arr;
        if(dep) l2.textContent = dep;

        if(flexMin > 0){
          l3.textContent = minsToHHMM(flexMin);
          l3.classList.add('red');
        }else if(isVac){
          l3.textContent = 'Szabi';
          l3.classList.add('black');
        }else if(row.holiday_name && !entry){
          l3.textContent = row.holiday_name;
          l3.classList.add('black');
        }else{
          l3.textContent = '';
        }

        lines.appendChild(l1); lines.appendChild(l2); lines.appendChild(l3);
        tile.appendChild(top);
        tile.appendChild(lines);

        tile.addEventListener('click', ()=>openEdit(iso, row));
        grid.appendChild(tile);
      }

      renderJumpToday();
    }

    function validateEditForm(){
      const inV = $('arrSel').value;
      const outV = $('depSel').value;

      const inWrap = $('arrSel').parentElement;
      const outWrap = $('depSel').parentElement;

      if(inV && outV){
        const inM = hhmmToMins(inV);
        const outM = hhmmToMins(outV);
        if(outM < inM){
          $('editErr').textContent = 'Hiba: Távozás nem lehet korábbi, mint Érkezés!';
          $('editErr').classList.remove('hidden');
          inWrap.classList.add('invalid');
          outWrap.classList.add('invalid');
          $('saveBtn').disabled = true;
          return false;
        }
      }
      $('editErr').classList.add('hidden');
      inWrap.classList.remove('invalid');
      outWrap.classList.remove('invalid');
      $('saveBtn').disabled = false;
      return true;
    }

    function openEdit(iso, calRow){
      editingDate = iso;
      editingCalRow = calRow;

      $('editDate').textContent = iso.replaceAll('-', '.');
      $('editErr').classList.add('hidden');

      const entry = entriesByDate.get(iso) || {};
      $('arrSel').value = entry.arrival ? String(entry.arrival).slice(0,5) : '';
      $('depSel').value = entry.departure ? String(entry.departure).slice(0,5) : '';
      const flexMin = Number(entry.flex_minutes || 0);
      $('flexSel').value = flexMin > 0 ? String(flexMin) : '';
      $('vacChk').checked = !!entry.is_vacation;
      $('noteTxt').value = entry.note ? String(entry.note) : '';

      const today = getTodayISO();
      const isFuture = iso > today;

      const isSpecial = !!calRow.special_workday;
      const isHolidayOrRest = (!calRow.is_workday);
      const weekend = isWeekendISO(iso);

      const disVac = (!isSpecial) && (weekend || isHolidayOrRest);
      const disFlexWeekendHoliday = (!isSpecial) && (weekend || isHolidayOrRest);

      const disArrDepFuture = isFuture;
      const disFlexFuture = isFuture;

      $('arrSel').disabled = disArrDepFuture;
      $('depSel').disabled = disArrDepFuture;
      $('flexSel').disabled = disFlexWeekendHoliday || disFlexFuture;
      $('vacChk').disabled = disVac;

      const syncVacationFlex = ()=>{
        if($('vacChk').checked){
          $('flexSel').value = '';
          $('flexSel').disabled = true;
        }else{
          $('flexSel').disabled = (disFlexWeekendHoliday || disFlexFuture);
        }
      };
      syncVacationFlex();

      $('vacChk').onchange = ()=>{ syncVacationFlex(); };

      $('modalBackdrop').classList.remove('hidden');
      validateEditForm();
    }

    function closeEdit(){
      $('modalBackdrop').classList.add('hidden');
      editingDate = null;
      editingCalRow = null;
    }

    function clearEditForm(){
      $('arrSel').value = '';
      $('depSel').value = '';
      $('flexSel').value = '';
      $('vacChk').checked = false;
      $('noteTxt').value = '';
      validateEditForm();
    }

    async function loadProfile(){
      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      if(!uid) return null;

      const { data, error } = await supabase
        .from('profiles')
        .select('display_name,email,role')
        .eq('user_id', uid)
        .maybeSingle();

      if(error) throw error;

      profile = data || { display_name: u.user.email, email: u.user.email, role: 'user' };
      $('userName').textContent = profile.display_name || profile.email || '';

      const role = String(profile.role || 'user');
      if(role === 'admin' || role === 'manager'){
        $('settingsBtn').classList.remove('hidden');
      }else{
        $('settingsBtn').classList.add('hidden');
      }
    }

    async function loadMonth(){
      const start = `${curYear}-${String(curMonth).padStart(2,'0')}-01`;
      const end = curMonth===12 ? `${curYear+1}-01-01` : `${curYear}-${String(curMonth+1).padStart(2,'0')}-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', curYear)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });
      if(e1) throw e1;

      monthRows = (days || []).map(r => ({ ...r, date: normalizeIsoDate(r.date) }));

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('user_id,date,arrival,departure,flex_minutes,is_vacation,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });
      if(e2) throw e2;

      entriesByDate = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        entriesByDate.set(iso, { ...r, date: iso });
      });

      $('monthTitle').textContent = `${curYear} ${huMonthName(curMonth)}`;
      renderGrid();
    }

    async function saveCurrentEdit(){
      const iso = editingDate;
      if(!iso) return;

      const today = getTodayISO();
      const isFuture = iso > today;

      const payload = {
        date: iso,
        arrival: isFuture ? null : ($('arrSel').value || null),
        departure: isFuture ? null : ($('depSel').value || null),
        flex_minutes: isFuture ? 0 : ($('flexSel').value ? Number($('flexSel').value) : 0),
        is_vacation: $('vacChk').checked,
        note: ($('noteTxt').value || '').trim()
      };

      if(payload.is_vacation){
        payload.flex_minutes = 0;
      }

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      if(!uid) throw new Error('Nincs user session.');

      const { error } = await supabase
        .from('entries')
        .upsert({ user_id: uid, ...payload }, { onConflict: 'user_id,date' });
      if(error) throw error;

      const isEmpty =
        !payload.arrival &&
        !payload.departure &&
        (payload.flex_minutes === 0) &&
        !payload.is_vacation &&
        (!payload.note || payload.note.length === 0);

      if(isEmpty){
        entriesByDate.delete(iso);
      }else{
        entriesByDate.set(iso, { user_id: uid, ...payload });
      }
    }

    function initFromQueryOrToday(){
      const qs = new URLSearchParams(location.search);
      const qy = Number(qs.get('y') || '');
      const qm = Number(qs.get('m') || '');
      if(qy === 2026 && qm>=1 && qm<=12){
        curYear = qy; curMonth = qm;
        return;
      }
      const today = getTodayISO();
      curYear = Number(today.slice(0,4));
      curMonth = Number(today.slice(5,7));
    }

    async function boot(){
      await ensureSupabase();

      const { data } = await supabase.auth.getSession();
      if(!data.session){
        location.replace('/index.html?v=' + Date.now());
        return;
      }

      await loadProfile();

      buildTimeOptions($('arrSel'), 15, 24*60);
      buildTimeOptions($('depSel'), 15, 24*60);
      buildFlexMinutesOptions($('flexSel'), 15, 8*60);

      initFromQueryOrToday();
      await loadMonth();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      $('logoutBtn').addEventListener('click', async ()=>{
        try{
          await ensureSupabase();
          await supabase.auth.signOut();
        }catch(_){}
        location.replace('/index.html?v=' + Date.now());
      });

      $('sumBtn').addEventListener('click', ()=>{
        location.href = '/adatlap.html?v=' + Date.now();
      });

      $('settingsBtn').addEventListener('click', ()=>{
        location.href = '/manager.html?v=' + Date.now();
      });

      $('prevBtn').addEventListener('click', async ()=>{
        const nav = getMonthNav(curYear, curMonth, -1);
        if(nav.y!==2026) return;
        curYear = nav.y; curMonth = nav.m;
        await loadMonth();
      });
      $('nextBtn').addEventListener('click', async ()=>{
        const nav = getMonthNav(curYear, curMonth, +1);
        if(nav.y!==2026) return;
        curYear = nav.y; curMonth = nav.m;
        await loadMonth();
      });

      $('jumpTodayBtn').addEventListener('click', async ()=>{
        initFromQueryOrToday();
        await loadMonth();
      });

      $('modalBackdrop').addEventListener('click', (e)=>{
        if(e.target === $('modalBackdrop')) closeEdit();
      });

      $('arrSel').addEventListener('change', validateEditForm);
      $('depSel').addEventListener('change', validateEditForm);

      $('delBtn').addEventListener('click', ()=>clearEditForm());

      $('saveBtn').addEventListener('click', async ()=>{
        if(!validateEditForm()) return;
        try{
          await saveCurrentEdit();
          closeEdit();
          await loadMonth();
        }catch(e){
          toast('Mentés hiba: ' + (e?.message||String(e)));
        }
      });

      boot().catch(e=>toast('Indulási hiba: ' + (e?.message||String(e))));
    });
  })();
  </script>
</body>
</html>
