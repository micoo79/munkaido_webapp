<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VMKK KultÓra</title>

  <link rel="manifest" href="/manifest.webmanifest?v=1" />
  <meta name="theme-color" content="#27272a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VMKK KultÓra" />

  <link rel="icon" type="image/png" href="/kult_logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=1" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png?v=1" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png?v=1" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#52525b;

      --zold:#1ecb5b;
      --piros:#ff3b30;

      --border:#3f3f46;
      --card:#2f2f33;

      --inactive:#52525b;
      --inactiveLbl:#9ca3af;
    }

    /* ✅ Light theme (profilból mentve) */
    html[data-theme="light"]{
      --bg:#f3f4f6;
      --panel:#ffffff;
      --text:#111827;
      --muted:#6b7280;

      --rest:#e5e7eb;
      --holiday:#fecaca;
      --vac:#bfdbfe;
      --work:#ffffff;
      --weekend:#d1d5db;

      --border:#e5e7eb;
      --card:#ffffff;

      --inactive:#e5e7eb;
      --inactiveLbl:#6b7280;
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    a{color:var(--text); text-decoration:none;}

    .header{
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:transparent;
    }
    .user-block{display:flex; align-items:center; gap:8px; min-width:0;}
    .user-name{
      font-weight:900; font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:48vw;
    }

    .nav-container{display:flex; gap:0; align-items:center;}
    .nav-item{
      border:0; background:transparent; color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      width:44px; height:52px; position:relative; cursor:pointer;
      -webkit-tap-highlight-color:transparent; padding:0;
    }
    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      transition:color .2s ease; line-height:1;
    }
    .menu-label{
      font-size:10px; position:absolute; bottom:4px; left:50%;
      transform:translateX(-50%); white-space:nowrap; pointer-events:none;
      transition:opacity .2s ease, color .2s ease;
    }

    .logout-item .material-symbols-outlined{ color:var(--text); opacity:1; }
    .logout-item .menu-label{ color:var(--text); opacity:1; }

    .rec-item .menu-label{opacity:1; color:var(--text);}
    .rec-item:hover .material-symbols-outlined,
    .rec-item:hover .menu-label{color:var(--accent);}

    .sum-item .menu-label{opacity:1; color:var(--text);}
    .sum-item:hover .material-symbols-outlined,
    .sum-item:hover .menu-label{color:var(--accent);}

    .settings-item .menu-label{opacity:0;}
    .settings-item:hover .material-symbols-outlined,
    .settings-item:hover .menu-label{ opacity:1; color:var(--accent); }

    @media (max-width:520px){
      #settingsBtn{display:none !important;}
    }

    .hidden{display:none !important;}

    .wrap{max-width:900px; margin:0 auto; padding:0 12px 18px;}
    .card{background:var(--panel); border:0; border-radius:16px; padding:10px;}

    .toolbar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      padding:6px 4px 10px;
    }
    .titleRow{display:flex; flex-direction:column; gap:2px; min-width:0;}
    .title{font-size:16px; font-weight:900; margin:0;}
    .sub{font-size:13px; color:var(--muted); font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:80vw;}

    .btn{
      border:0;
      border-radius:12px;
      padding:10px 12px;
      font-size:14px;
      font-weight:900;
      cursor:pointer;
      background:var(--border);
      color:var(--text);
      transition:background .15s, transform .05s;
      user-select:none;
      -webkit-tap-highlight-color:transparent;
    }
    .btn:hover{background:#52525b;}
    html[data-theme="light"] .btn:hover{background:#e5e7eb;}
    .btn:active{transform:scale(.98);}
    .btn.primary{background:var(--accent); color:#111;}
    .btn.small{padding:8px 10px; font-size:13px; border-radius:10px;}
    .btn.ghost{background:transparent; border:1px solid var(--border);}

    .monthNav{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .monthLabel{
      font-weight:900; font-size:14px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      min-width:160px;
      text-align:center;
    }

    .gridWrap{overflow:visible;}
    .grid{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      table-layout:fixed;
    }
    .grid th, .grid td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      text-align:left;
      vertical-align:middle;
      border-right:1px solid rgba(255,255,255,.10);
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:0;
    }
    html[data-theme="light"] .grid th,
    html[data-theme="light"] .grid td{
      border-bottom:1px solid rgba(0,0,0,.08);
      border-right:1px solid rgba(0,0,0,.08);
    }
    .grid th:last-child, .grid td:last-child{ border-right:0; }
    .grid th{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.02em;
      position:sticky;
      top:0;
      z-index:50;
      background:var(--panel);
      box-shadow: 0 2px 0 rgba(255,255,255,.06);
      white-space:normal;
      overflow:visible;
      text-overflow:clip;
      line-height:1.15;
      overflow-wrap:anywhere;
      word-break:break-word;
      hyphens:auto;
    }
    html[data-theme="light"] .grid th{
      box-shadow: 0 2px 0 rgba(0,0,0,.06);
    }
    .grid td{ font-size:13px; font-weight:800; }
    .muted{ color:var(--muted); font-weight:800; }

    .dayPill{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      font-weight:900;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
    }
    html[data-theme="light"] .dayPill{
      border:1px solid rgba(0,0,0,.10);
      background:rgba(0,0,0,.03);
    }
    .pillHoliday{ background:rgba(246,178,178,.18); border-color:rgba(246,178,178,.35); }
    .pillVac{ background:rgba(185,217,255,.18); border-color:rgba(185,217,255,.35); }
    .pillSick{ background:rgba(30,203,91,.18); border-color:rgba(30,203,91,.40); }

    .formCard{
      margin-top:12px;
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
    }

    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .row label{font-size:15px; font-weight:800; min-width:120px;}
    .row .ctrl{flex:1; min-width:200px; display:flex; justify-content:flex-end;}

    select{
      width:60%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      color:#111;
      font-size:14px;
      outline:none;
    }
    select:disabled{
      background:var(--inactive) !important;
      color:#e5e7eb !important;
      border-color:rgba(255,255,255,.14) !important;
    }

    textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:#111;
      font-size:14px;
      outline:none;
      min-height:90px;
      resize:none;
      margin-top:8px;
    }

    .chkRow{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      padding:12px;
      border-radius:12px;
      background:#fff;
      color:#111;
      border:1px solid var(--border);
      margin-top:10px;
    }
    .chkRow .left{font-weight:900;}
    .chkRow input[type="checkbox"]{
      width:22px; height:22px; accent-color: var(--accent);
    }

    .saveWrap{
      margin-top:12px;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:18px;
      z-index:99;
      font-weight:900;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="user-block">
      <div id="userName" class="user-name"></div>
      <button id="logoutBtn" class="nav-item logout-item" type="button" aria-label="Kilépés">
        <span class="material-symbols-outlined">logout</span>
        <span class="menu-label">Kilépés</span>
      </button>
    </div>

    <nav class="nav-container">
      <button id="calendarBtn" class="nav-item rec-item hidden" type="button" aria-label="Rögzítés">
        <span class="material-symbols-outlined">edit_calendar</span>
        <span class="menu-label">Rögzítés</span>
      </button>

      <button id="sumBtn" class="nav-item sum-item" type="button" aria-label="Összesítő">
        <span class="material-symbols-outlined">overview</span>
        <span class="menu-label">Összesítő</span>
      </button>

      <button id="settingsBtn" class="nav-item settings-item hidden" type="button" aria-label="Beállítások">
        <span class="material-symbols-outlined">settings</span>
        <span class="menu-label">Beállítások</span>
      </button>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="toolbar">
        <div class="titleRow" style="min-width:0;">
          <h1 id="monthTitle" class="title">Betöltés…</h1>
          <div id="monthSub" class="sub">—</div>
        </div>

        <div class="monthNav">
          <button id="prevBtn" class="btn small" type="button">◀</button>
          <div id="monthLabel" class="monthLabel">—</div>
          <button id="nextBtn" class="btn small" type="button">▶</button>
        </div>
      </div>

      <div class="gridWrap">
        <div id="grid" class="grid"></div>
      </div>

      <div class="formCard">
        <div class="row">
          <label for="arrSel">Érkezés</label>
          <div class="ctrl"><select id="arrSel"></select></div>
        </div>

        <div class="row">
          <label for="depSel">Távozás</label>
          <div class="ctrl"><select id="depSel"></select></div>
        </div>

        <div class="row">
          <label for="flexSel">Csúsztatás</label>
          <div class="ctrl"><select id="flexSel"></select></div>
        </div>

        <div class="chkRow">
          <div class="left">Szabadság</div>
          <input id="vacChk" type="checkbox" />
        </div>

        <div class="chkRow">
          <div class="left">Betegállomány</div>
          <input id="sickChk" type="checkbox" />
        </div>

        <textarea id="noteTxt" placeholder="Megjegyzés (opcionális)"></textarea>

        <div class="saveWrap">
          <button id="saveBtn" class="btn primary" type="button">Mentés</button>
        </div>
      </div>
    </section>
  </main>

  <script>
  (() => {
    const $ = (id)=>document.getElementById(id);
    const toast = (t)=>{
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=t;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    };

    // ✅ TESZT "mai nap" - marad 2026-04-16
    const DEV_TODAY = '2026-04-16';
    const YEAR = 2026;

    let supabase = null;
    let profile = null;
    let isMgr = false;
    let currentUserId = null;

    // selected month
    let month = 4; // default
    // selected day in month grid (iso)
    let selectedIso = null;

    // computed for status / checks
    let expectedTotalToToday = 0;
    let fulfilledTotalToToday = 0;
    let vacTakenToToday = 0;

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function normalizeIsoDate(d){
      return String(d).slice(0,10);
    }

    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }

    function pad2(n){ return String(n).padStart(2,'0'); }

    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const [h,m] = String(hhmm).slice(0,5).split(':').map(Number);
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.abs(Math.trunc(Number(mins)||0));
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function noStoreFetch(input, init){
      const o = init ? { ...init } : {};
      o.cache = 'no-store';
      return fetch(input, o);
    }

    // ✅ Theme helper (profilból)
    function applyTheme(theme){
      const t = (theme === 'light') ? 'light' : 'dark';
      document.documentElement.dataset.theme = t;

      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta){
        meta.setAttribute('content', t === 'light' ? '#f3f4f6' : '#27272a');
      }
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' },
        global:{ fetch: noStoreFetch }
      });
      return supabase;
    }

    // ✅ app.html-es wheel logika (gap blank)
    function buildTimeOptionsWithGap(selectEl, step=15, max=24*60, blankAfterHHMM=null){
      selectEl.innerHTML = '';
      let gapIndex = -1;

      for(let t=0; t<=max; t+=step){
        const h = Math.floor(t/60);
        const mm = t%60;
        const val = `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;

        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);

        if(blankAfterHHMM && val === blankAfterHHMM){
          const optGapBlank = document.createElement('option');
          optGapBlank.value = '';
          optGapBlank.textContent = '';
          selectEl.appendChild(optGapBlank);
          gapIndex = selectEl.options.length - 1;
        }
      }

      if(gapIndex < 0){
        const optBlank = document.createElement('option');
        optBlank.value = '';
        optBlank.textContent = '';
        selectEl.insertBefore(optBlank, selectEl.firstChild);
        gapIndex = 0;
      }

      selectEl.dataset.gapBlankIndex = String(gapIndex);
      selectEl.selectedIndex = gapIndex;
    }

    function setSelectToGapBlank(selectEl){
      const idx = Number(selectEl.dataset.gapBlankIndex || 0);
      if(Number.isFinite(idx) && selectEl.options && selectEl.options[idx]){
        selectEl.selectedIndex = idx;
      }else{
        selectEl.value = '';
      }
    }

    function buildFlexOptions(selectEl){
      selectEl.innerHTML = '';
      const optBlank = document.createElement('option');
      optBlank.value = '';
      optBlank.textContent = '';
      selectEl.appendChild(optBlank);

      // 0..240 perc 15-ösével
      for(let m=0; m<=240; m+=15){
        const opt = document.createElement('option');
        opt.value = String(m);
        opt.textContent = (m===0) ? '0 perc' : `${m} perc`;
        selectEl.appendChild(opt);
      }
      selectEl.value = '';
    }

    function getQueryMonth(){
      const u = new URL(location.href);
      const qm = Number(u.searchParams.get('m') || '');
      if(qm>=1 && qm<=12) return qm;
      return null;
    }

    function setQueryMonth(m){
      const u = new URL(location.href);
      u.searchParams.set('y', String(YEAR));
      u.searchParams.set('m', String(m));
      u.searchParams.set('v', String(Date.now()));
      history.replaceState(null, '', u.toString());
    }

    function roleIsMgr(r){
      const role = String(r||'user');
      return (role === 'admin' || role === 'manager');
    }

    async function loadProfile(){
      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      currentUserId = uid;
      if(!uid) return null;

      const { data, error } = await supabase
        .from('profiles')
        .select('user_id,display_name,email,role,daily_expected_minutes,vacation_entitlement_days,vacation_carryover_days,flex_carryover_minutes,flex_bonus_minutes,theme')
        .eq('user_id', uid)
        .maybeSingle();
      if(error) throw error;

      profile = data || {
        user_id: uid,
        display_name: u.user.email,
        email: u.user.email,
        role:'user',
        daily_expected_minutes:480,
        vacation_entitlement_days:0,
        vacation_carryover_days:0,
        flex_carryover_minutes:0,
        flex_bonus_minutes:0,
        theme: null
      };

      // ✅ Theme alkalmazása (profilból)
      applyTheme(profile?.theme || 'dark');

      $('userName').textContent = profile.display_name || profile.email || '';

      isMgr = roleIsMgr(profile.role);
      if(isMgr){
        $('settingsBtn').classList.remove('hidden');
      }else{
        $('settingsBtn').classList.add('hidden');
      }

      return profile;
    }

    function calcWorkedHoursFromArrivalDeparture(arrival, departure, flexMinutes){
      const a = hhmmToMins(arrival);
      const b = hhmmToMins(departure);
      if(a == null || b == null) return '';
      if(b < a) return '';
      let worked = (b - a) - Math.max(0, Number(flexMinutes||0));
      worked = Math.max(0, worked);
      return minsToHHMM(worked);
    }

    function dayPillsFromDay(cal, entry){
      const pills = [];
      if(cal && !cal.is_workday && cal.holiday_name){
        pills.push(`<span class="dayPill pillHoliday">${escapeHtml(cal.holiday_name)}</span>`);
      }else if(cal && !!cal.special_workday){
        pills.push(`<span class="dayPill">Szombati munkanap</span>`);
      }else if(cal && !cal.is_workday){
        pills.push(`<span class="dayPill">Pihenőnap</span>`);
      }else if(cal && isWeekendISO(cal.date)){
        pills.push(`<span class="dayPill">Hétvége</span>`);
      }

      if(entry?.is_vacation){
        pills.push(`<span class="dayPill pillVac">Szabadság</span>`);
      }
      if(entry?.is_sick){
        pills.push(`<span class="dayPill pillSick">Betegállomány</span>`);
      }
      return pills.join(' ');
    }

    function escapeHtml(s){
      return String(s||'')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function renderHeader(){
      $('monthTitle').textContent = `${YEAR}. ${huMonthName(month)}`;
      $('monthLabel').textContent = `${huMonthName(month)} ${YEAR}`;
      $('monthSub').textContent = `Válassz napot, majd rögzíts. (Teszt dátum: ${getTodayISO().replaceAll('-','.')})`;
    }

    function daysInMonth(y,m){
      return new Date(y, m, 0, 12,0,0).getDate();
    }

    function isoOf(y,m,day){
      return `${y}-${pad2(m)}-${pad2(day)}`;
    }

    function weekdayMonFirst(iso){
      const d = new Date(iso+'T12:00:00');
      let wd = d.getDay();
      if(wd===0) wd=7;
      return wd; // 1..7 (Mon..Sun)
    }

    async function loadMonthData(){
      const start = `${YEAR}-${pad2(month)}-01`;
      const end = (month===12) ? `${YEAR+1}-01-01` : `${YEAR}-${pad2(month+1)}-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', YEAR)
        .gte('date', start)
        .lt('date', end)
        .order('date', { ascending:true });
      if(e1) throw e1;

      const calMap = new Map();
      (days||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        calMap.set(iso, { ...r, date: iso });
      });

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end);
      if(e2) throw e2;

      const entMap = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        entMap.set(iso, { ...r, date: iso });
      });

      return { calMap, entMap };
    }

    function renderMonthGrid(calMap, entMap){
      const host = $('grid');
      const dim = daysInMonth(YEAR, month);

      const firstIso = isoOf(YEAR, month, 1);
      const offset = weekdayMonFirst(firstIso) - 1; // 0..6

      let html = '';
      html += `<table class="grid"><thead><tr>`;
      html += `<th style="width:16%">Dátum</th>`;
      html += `<th style="width:18%">Érkezés</th>`;
      html += `<th style="width:18%">Távozás</th>`;
      html += `<th style="width:18%">Ledolgozott</th>`;
      html += `<th style="width:14%">Csúsztatás</th>`;
      html += `<th style="width:16%">Státusz</th>`;
      html += `</tr></thead><tbody>`;

      for(let i=0;i<offset;i++){
        html += `<tr><td class="muted" colspan="6">—</td></tr>`;
      }

      for(let d=1; d<=dim; d++){
        const iso = isoOf(YEAR, month, d);
        const cal = calMap.get(iso);
        const entry = entMap.get(iso);

        const arrival = entry?.arrival ? String(entry.arrival).slice(0,5) : '';
        const departure = entry?.departure ? String(entry.departure).slice(0,5) : '';
        const flexM = entry ? Number(entry.flex_minutes||0) : 0;
        const flexTxt = (entry && flexM>0) ? `${flexM} perc` : '';

        const worked = calcWorkedHoursFromArrivalDeparture(arrival, departure, flexM);
        const status = dayPillsFromDay(cal, entry);

        const isSelected = (iso === selectedIso);
        html += `
          <tr data-iso="${escapeHtml(iso)}" style="${isSelected ? 'outline:2px solid var(--accent); outline-offset:-2px;' : ''}">
            <td>${escapeHtml(iso.replaceAll('-','.'))}</td>
            <td>${escapeHtml(arrival)}</td>
            <td>${escapeHtml(departure)}</td>
            <td>${escapeHtml(worked)}</td>
            <td>${escapeHtml(flexTxt)}</td>
            <td>${status || '<span class="muted">—</span>'}</td>
          </tr>
        `;
      }

      html += `</tbody></table>`;
      host.innerHTML = html;

      host.querySelectorAll('tr[data-iso]').forEach(tr=>{
        tr.addEventListener('click', ()=>{
          const iso = tr.getAttribute('data-iso');
          if(!iso) return;
          selectedIso = iso;
          setFormFromEntry(entMap.get(iso));
          renderMonthGrid(calMap, entMap);
        });
      });
    }

    function setFormFromEntry(entry){
      if(entry){
        const arr = entry.arrival ? String(entry.arrival).slice(0,5) : '';
        const dep = entry.departure ? String(entry.departure).slice(0,5) : '';
        const flex = (Number(entry.flex_minutes||0) > 0) ? String(Number(entry.flex_minutes||0)) : '';

        $('arrSel').value = arr || '';
        $('depSel').value = dep || '';
        $('flexSel').value = flex || '';
        $('vacChk').checked = !!entry.is_vacation;
        $('sickChk').checked = !!entry.is_sick;
        $('noteTxt').value = entry.note || '';
      }else{
        setSelectToGapBlank($('arrSel'));
        setSelectToGapBlank($('depSel'));
        $('flexSel').value = '';
        $('vacChk').checked = false;
        $('sickChk').checked = false;
        $('noteTxt').value = '';
      }
    }

    async function computeYearToTodayStats(){
      const today = getTodayISO();
      const start = `${YEAR}-01-01`;
      const end = `${YEAR+1}-01-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', YEAR)
        .order('date', { ascending:true });
      if(e1) throw e1;

      const calRows = (days||[]).map(r=>({ ...r, date: normalizeIsoDate(r.date) }))
        .sort((a,b)=>a.date.localeCompare(b.date));

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end);
      if(e2) throw e2;

      const eMap = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        eMap.set(iso, { ...r, date: iso });
      });

      const expPerDay = Number(profile?.daily_expected_minutes || 480);
      expectedTotalToToday = 0;
      fulfilledTotalToToday = 0;
      vacTakenToToday = 0;

      for(const cal of calRows){
        const iso = cal.date;
        if(iso > today) break;

        const entry = eMap.get(iso);
        const isWorkday = !!cal.is_workday;
        const isSpecial = !!cal.special_workday;

        const expected = isWorkday ? expPerDay : 0;
        expectedTotalToToday += expected;

        let fulfilled = 0;

        if(entry){
          const vac = !!entry.is_vacation;
          const sick = !!entry.is_sick;

          if((vac || sick) && isWorkday){
            fulfilled += expected;
          }

          if(vac && isWorkday && iso <= today){
            vacTakenToToday++;
          }

          let worked = 0;
          if(entry.arrival && entry.departure){
            const inM = hhmmToMins(entry.arrival);
            const outM = hhmmToMins(entry.departure);
            if(inM != null && outM != null && outM >= inM){
              worked = outM - inM;
            }
          }
          const flexM = Math.max(0, Number(entry.flex_minutes || 0));
          worked = Math.max(0, worked - flexM);

          const isWeekendOrHolidayDouble = (!isWorkday && !isSpecial);
          let mult = 1;
          if(isWeekendOrHolidayDouble) mult = 2;
          if(vac && worked > 0) mult = 2;

          fulfilled += (worked * mult);
        }

        fulfilledTotalToToday += fulfilled;
      }
    }

    function updateStatusBar(){
      // (A státusz sor opcionális; ha nincs a DOM-ban, nem csinálunk semmit)
      const vacEl = $('statVac');
      const balEl = $('statBal');
      if(!vacEl && !balEl) return;

      const E = Number(profile?.vacation_entitlement_days || 0) + Number(profile?.vacation_carryover_days || 0);
      const X = Math.max(0, E - (vacTakenToToday || 0));

      if(vacEl){
        vacEl.textContent = String(Math.round(X));
      }

      if(!balEl) return;

      const carry = Number(profile?.flex_carryover_minutes || 0);
      const bonus = Number(profile?.flex_bonus_minutes || 0);
      const balance = (carry + bonus) + (fulfilledTotalToToday - expectedTotalToToday);

      const abs = Math.abs(Math.round(balance));
      const hhmm = minsToHHMM(abs);

      balEl.textContent = (balance >= 0) ? `+${hhmm}` : `-${hhmm}`;
      balEl.classList.toggle('pos', balance >= 0);
      balEl.classList.toggle('neg', balance < 0);
    }

    function getCurrentFormState(){
      return {
        arrival: $('arrSel').value || '',
        departure: $('depSel').value || '',
        flex: $('flexSel').value || '',
        vac: !!$('vacChk').checked,
        sick: !!$('sickChk').checked,
        note: ($('noteTxt').value || '')
      };
    }

    function validateFormState(st){
      // ha szabi vagy beteg: arrival/dep optional
      if(st.vac || st.sick) return true;

      // ha bármelyik idő ki van választva, mindkettő kell és érkezés<=távozás
      if(st.arrival || st.departure){
        if(!st.arrival || !st.departure) return false;
        const a = hhmmToMins(st.arrival);
        const d = hhmmToMins(st.departure);
        if(a == null || d == null) return false;
        if(d < a) return false;
      }
      return true;
    }

    async function saveSelectedDay(){
      if(!selectedIso){
        toast('Válassz napot a táblázatból');
        return;
      }

      const st = getCurrentFormState();
      if(!validateFormState(st)){
        toast('Hiba: az időpontok nem jók');
        return;
      }

      const payload = {
        user_id: currentUserId,
        date: selectedIso,
        arrival: st.arrival || null,
        departure: st.departure || null,
        flex_minutes: st.flex ? Number(st.flex || 0) : 0,
        is_vacation: st.vac,
        is_sick: st.sick,
        note: st.note || null
      };

      // ha minden üres és nincs státusz -> törlés
      const nothing =
        !payload.arrival && !payload.departure &&
        !(Number(payload.flex_minutes||0) > 0) &&
        !payload.is_vacation && !payload.is_sick &&
        !payload.note;

      try{
        if(nothing){
          const { error } = await supabase
            .from('entries')
            .delete()
            .eq('user_id', currentUserId)
            .eq('date', selectedIso);
          if(error) throw error;
          toast('Törölve');
        }else{
          const { error } = await supabase
            .from('entries')
            .upsert(payload, { onConflict:'user_id,date' });
          if(error) throw error;
          toast('Mentve');
        }

        // újratöltjük a hónapot
        const { calMap, entMap } = await loadMonthData();
        renderMonthGrid(calMap, entMap);

        // újra számolunk az évre, státusz frissítés (ha van)
        await computeYearToTodayStats();
        updateStatusBar();
      }catch(e){
        toast(e?.message || String(e));
      }
    }

    function applyMonthFromUrl(){
      const qm = getQueryMonth();
      if(qm) month = qm;
    }

    async function refreshMonth(){
      renderHeader();
      const { calMap, entMap } = await loadMonthData();

      // ha nincs kiválasztott nap, álljon a mai napra (ha ebben a hónapban van)
      const today = getTodayISO();
      const todayM = Number(today.slice(5,7));
      if(!selectedIso && todayM === month){
        selectedIso = today;
      }
      // ha kiválasztott nap másik hónap -> null
      if(selectedIso && Number(String(selectedIso).slice(5,7)) !== month){
        selectedIso = null;
      }

      setFormFromEntry(selectedIso ? entMap.get(selectedIso) : null);
      renderMonthGrid(calMap, entMap);
    }

    let refreshing = false;
    async function refresh(){
      if(refreshing) return;
      refreshing = true;
      try{
        await ensureSupabase();

        const { data } = await supabase.auth.getSession();
        if(!data.session){
          location.replace('/index.html?v=' + Date.now());
          return;
        }

        applyMonthFromUrl();
        await loadProfile();
        renderHeader();

        // selectek
        buildTimeOptionsWithGap($('arrSel'), 15, 24*60, '08:00');
        buildTimeOptionsWithGap($('depSel'), 15, 24*60, '16:00');
        buildFlexOptions($('flexSel'));

        await computeYearToTodayStats();
        updateStatusBar();

        await refreshMonth();
      }finally{
        refreshing = false;
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      $('logoutBtn').addEventListener('click', async ()=>{
        try{
          await ensureSupabase();
          await supabase.auth.signOut();
        }catch(_){}
        location.replace('/index.html?v=' + Date.now());
      });

      $('sumBtn').addEventListener('click', ()=>{
        location.href = '/adatlap.html?v=' + Date.now();
      });

      $('settingsBtn').addEventListener('click', ()=>{
        location.href = '/manager.html?v=' + Date.now();
      });

      $('prevBtn').addEventListener('click', async ()=>{
        month = (month<=1) ? 12 : (month-1);
        setQueryMonth(month);
        await refreshMonth().catch(e=>toast(e?.message||String(e)));
      });

      $('nextBtn').addEventListener('click', async ()=>{
        month = (month>=12) ? 1 : (month+1);
        setQueryMonth(month);
        await refreshMonth().catch(e=>toast(e?.message||String(e)));
      });

      $('saveBtn').addEventListener('click', saveSelectedDay);

      refresh().catch(e=>toast('Indulási hiba: ' + (e?.message||String(e))));

      window.addEventListener('pageshow', ()=>{ refresh().catch(()=>{}); });
      window.addEventListener('focus', ()=>{ refresh().catch(()=>{}); });
      document.addEventListener('visibilitychange', ()=>{
        if(!document.hidden) refresh().catch(()=>{});
      });
    });
  })();
  </script>
</body>
</html>
