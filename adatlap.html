<!-- adatlap.html (Összesítő) -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>VMKK KultÓra</title>

  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VMKK KultÓra" />

  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png?v=1">
  <link rel="apple-touch-icon-precomposed" href="/icons/apple-touch-icon.png?v=1">

  <link rel="manifest" href="/manifest.webmanifest?v=1" />
  <meta name="theme-color" content="#27272a" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="VMKK KultÓra" />

  <link rel="icon" type="image/png" href="/kult_logo.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png?v=1" />
  <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png?v=1" />
  <link rel="icon" type="image/png" sizes="512x512" href="/icons/icon-512.png?v=1" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#777b81;

      --zold:#1ecb5b; /* betegszabadság */
      --piros:#ff3b30;

      --day:16px;
      --dayGap:1px;
      --monthGap:3px;
      --dayFont:11px;

      --monthPad:8px;
      --monthGridW: calc(7 * var(--day) + 6 * var(--dayGap));
      --monthCardW: calc(var(--monthGridW) + 2 * var(--monthPad));

      --inactive:#52525b;
      --inactiveLbl:#9ca3af;
    }



html[data-theme="light"]{
  --bg:#f3f4f6;
  --panel:#ffffff;
  --text:#111827;
  --muted:#6b7280;

  --rest:#e5e7eb;
  --holiday:#fecaca;
  --vac:#bfdbfe;
  --work:#ffffff;
  --weekend:#d1d5db;

  --border:#e5e7eb;
  --card:#ffffff;

  --inactive:#e5e7eb;
  --inactiveLbl:#6b7280;

  /* ha kell: a zöld/piros maradhat */
}


    
    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* ----- HEADER ----- */
    .header{
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:transparent;
    }
    .user-block{display:flex; align-items:center; gap:6px; min-width:0;}
    .user-name{
      font-weight:700; font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:48vw;
    }
    .nav-container{display:flex; gap:0; align-items:center;}
    .nav-item{
      border:0; background:transparent; color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      width:44px; height:52px; position:relative; cursor:pointer;
      -webkit-tap-highlight-color:transparent; padding:0;
    }
    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      transition:color .2s ease; line-height:1;
    }
    .menu-label{
      font-size:10px; position:absolute; bottom:4px; left:50%;
      transform:translateX(-50%); white-space:nowrap; pointer-events:none;
      transition:opacity .2s ease, color .2s ease;
    }

    .logout-item .material-symbols-outlined{ color:var(--text); opacity:1; }
    .logout-item .menu-label{ color:var(--text); opacity:1; }

    .rec-item .menu-label{opacity:1; color:var(--text);}
    .rec-item:hover .material-symbols-outlined,
    .rec-item:hover .menu-label{color:var(--accent);}

    .sum-item{display:none !important;}

    .settings-item .menu-label{opacity:0;}
    .settings-item:hover .material-symbols-outlined,
    .settings-item:hover .menu-label{ opacity:1; color:var(--accent); }

    @media (max-width:520px){
      #settingsBtn{display:none !important;}
    }

    .hidden{display:none !important;}

    /* ----- CONTENT ----- */
    .wrap{max-width:900px; margin:0 auto; padding:0 12px 18px;}
    .card{background:var(--panel); border:0; border-radius:16px; padding:10px;}

    .summaryBox{
      display:flex; flex-direction:column; gap:8px;
      padding:10px 10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      margin-bottom:10px;
    }



    .btn.small{padding:8px 10px; font-size:13px; border-radius:10px;}
    
    .summaryLine{
      font-size:14px; line-height:1.25; color:var(--text);
      white-space:normal;
      word-break:break-word;
    }
    .summaryLine .num{font-size:115%; font-weight:800; color:var(--text) !important;}

    .missingBox{
      margin-top:6px;
      margin-bottom:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
    }
    .missingTitle{
      font-size:13px;
      margin:0;
      color:var(--text);
    }

    /* ✅ piros kis négyzet a mondatba (szám nélkül) */
    .inlineLegendSquare{
      display:inline-block;
      width:12px;
      height:12px;
      background:#ff4500;
      vertical-align:middle;
      margin:0 6px;
      border-radius:0;
    }

    .yearTitle{display:none !important;}

    .monthsWrap{
      display:flex;
      flex-wrap:wrap;
      gap:var(--monthGap);
      justify-content:center;
      align-items:flex-start;
    }

    .monthCard{
      width:var(--monthCardW);
      flex: 0 0 var(--monthCardW);
      background:rgba(255,255,255,.06);
      border-radius:10px;
      padding:var(--monthPad);
      overflow:hidden;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }

    .monthName{
      font-size:0.8rem;
      font-weight:800;
      text-align:center;
      margin:0 0 4px 0;
      line-height:1.1;
    }

    .miniDow{
      display:grid;
      grid-template-columns:repeat(7,var(--day));
      gap:var(--dayGap);
      margin-bottom:var(--dayGap);
      opacity:.9;
      justify-content:center;
    }
    .miniDow div{
      width:var(--day);
      height:12px;
      display:flex; align-items:center; justify-content:center;
      font-size:9px; font-weight:700; color:var(--muted);
      line-height:1;
    }

    .miniGrid{
      display:grid;
      grid-template-columns:repeat(7,var(--day));
      grid-template-rows:repeat(6,var(--day));
      gap:var(--dayGap);
      justify-content:center;
    }

    .dTile{
      width:var(--day);
      height:var(--day);
      border:0;
      border-radius:0;
      background:var(--work);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      user-select:none;
      overflow:hidden;
    }
    .dTile span{
      font-size:var(--dayFont);
      font-weight:700;
      line-height:1;
      color:#111;
      transform: translateY(0.5px);
    }

    .dTile.rest{background:var(--rest); opacity:1;}
    .dTile.weekend{background:var(--weekend);}
    .dTile.holiday{background:var(--holiday);}
    .dTile.vac{background:var(--vac);}
    .dTile.sick{background:var(--zold);}
    .dTile.workSaturday{background:var(--work);}

    .dTile.empty{background:transparent; border:0;}
    .dTile.empty span{display:none;}

    .dTile.today{
      outline:2px solid var(--accent);
      outline-offset:-2px;
    }

    .dTile.missing{
      background:#ff4500;
    }

    .dTile.weekend span{color:#fff;}
    .dTile.rest span{color:#9ca3af;}

    /* ✅ Jelmagyarázat (a naptár alatt) */
    .legendWrap{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .legendItem{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--text);
      font-size:12px;
      font-weight:700;
      white-space:nowrap;
      padding-top:5px;
    }
    .legendTile{
      width:18px;
      height:18px;
      border-radius:0;
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      font-size:11px;
      font-weight:900;
      line-height:1;
      color:#111;
    }
    .legendTile.holiday{ background:var(--holiday); }
    .legendTile.missing{ background:#ff4500; color:#111; }
    .legendTile.vac{ background:var(--vac); }
    .legendTile.sick{ background:var(--zold); }

    /* ✅ Napi gyorsgomb doboz */
    .quickBox{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
    }
    .quickTitle{
      font-size:13px;
      font-weight:800;
      margin:0 0 10px 0;
      color:var(--text);
    }

    /* app.html-s select / wheel stílus + elrendezés */
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;}
    .row label{font-size:16px; font-weight:400; min-width:120px;}
    .row .ctrl{flex:1; min-width:180px; display:flex; justify-content:flex-end;}

    select{
      width:60%;
      padding:4px 4px;
      border-radius:0px;
      border:1px solid rgba(255,255,255,.14);
      background:#ffffff;
      color:#111;
      font-size:0.7rem;
      outline:none;
    }

    select:disabled{
      background:var(--inactive) !important;
      color:#e5e7eb !important;
      border-color:rgba(255,255,255,.14) !important;
    }

    @media (max-width:520px){
      .row label{font-size:1rem;}
      select{font-size:0.7rem;}
      .row .ctrl{justify-content:flex-start;}
      select{width:100%;}
    }

    .quickAddBtn{
      margin-top:10px;
      width:100%;
      border:0;
      border-radius:6px;          /* app gombokhoz közelebb */
      height:44px;
      font-size:1rem;
      font-weight:900;
      cursor:pointer;
      background:var(--zold);
      color:#111;
      -webkit-tap-highlight-color:transparent;
    }
    .quickAddBtn:active{opacity:.9;}

    .quickHint{
      margin-top:8px;
      font-size:12px;
      color:var(--muted);
      font-weight:700;
    }

    .quickList{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .quickItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px;
      border-radius:12px;
      background:rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .quickItemText{
      font-size:13px;
      font-weight:800;
      color:var(--text);
    }
    .quickDelete{
      border:0;
      border-radius:6px;
      padding:8px 10px;
      font-size:12px;
      font-weight:900;
      cursor:pointer;
      background:#c9cbd1;
      color:#111;
    }

    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:18px;
      z-index:99;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="user-block">
      <div id="userName" class="user-name"></div>
      <button id="logoutBtn" class="nav-item logout-item" type="button" aria-label="Kilépés">
        <span class="material-symbols-outlined">logout</span>
        <span class="menu-label">Kilépés</span>
      </button>
    </div>

    <nav class="nav-container">
      <button id="calendarBtn" class="nav-item rec-item" type="button" aria-label="Rögzítés">
        <span class="material-symbols-outlined">edit_calendar</span>
        <span class="menu-label">Rögzítés</span>
      </button>

      <button id="sumBtn" class="nav-item sum-item" type="button" aria-label="Összesítő">
        <span class="material-symbols-outlined">overview</span>
        <span class="menu-label">Összesítő</span>
      </button>

      <button id="settingsBtn" class="nav-item settings-item hidden" type="button" aria-label="Beállítások">
        <span class="material-symbols-outlined">settings</span>
        <span class="menu-label">Beállítások</span>
      </button>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="summaryBox">
        <div id="sumFlex" class="summaryLine">Betöltés…</div>
        <div id="sumVac"  class="summaryLine">Betöltés…</div>
        <div id="sumSick" class="summaryLine hidden"></div>
      </div>

      <div id="missingBox" class="missingBox hidden">
        <div id="missingTitle" class="missingTitle"></div>
      </div>

      <div id="monthsWrap" class="monthsWrap"></div>

      <div class="legendWrap" aria-label="Jelmagyarázat">
        <div class="legendItem">
          <div class="legendTile holiday" aria-hidden="true"></div>
          <div>Ünnepnapok</div>
        </div>
        <div class="legendItem">
          <div class="legendTile missing" aria-hidden="true"></div>
          <div>Hiányzó rögzítések</div>
        </div>
        <div class="legendItem">
          <div class="legendTile vac" aria-hidden="true"></div>
          <div>Szabadságok</div>
        </div>
        <div class="legendItem">
          <div class="legendTile sick" aria-hidden="true"></div>
          <div>Betegállomány</div>
        </div>
      </div>

      <!-- ✅ ÚJ: Napi gyorsgomb létrehozása (app.html-es wheel/Select logika) -->
      <div class="quickBox" aria-label="Napi gyorsgomb létrehozása">
        <div class="quickTitle">Napi gyorsgomb létrehozása</div>

        <div class="row" style="margin-top:10px;">
          <label for="quickArrSel">Érkezés</label>
          <div class="ctrl"><select id="quickArrSel"></select></div>
        </div>

        <div style="height:18px;"></div>

        <div class="row">
          <label for="quickDepSel">Távozás</label>
          <div class="ctrl"><select id="quickDepSel"></select></div>
        </div>

        <button id="quickAddBtn" class="quickAddBtn hidden" type="button">Hozzáadás</button>
        <div id="quickHint" class="quickHint hidden"></div>

        <div id="quickList" class="quickList"></div>
      </div>



<div style="display:flex; justify-content:flex-end; margin-top:12px;">
  <button id="themeToggleBtn" class="btn small" type="button">Világos mód</button>
</div>




      
    </section>
  </main>

  <script>







const themeBtn = document.getElementById('themeToggleBtn');

applyTheme(profile.theme);                 // betöltéskor alkalmaz
setThemeButtonLabel(themeBtn, profile.theme);

themeBtn.addEventListener('click', async ()=>{
  const newTheme = nextTheme(profile.theme);
  applyTheme(newTheme);
  setThemeButtonLabel(themeBtn, newTheme);

  // mentés profilba
  const { error } = await supabase
    .from('profiles')
    .update({ theme: newTheme })
    .eq('user_id', profile.user_id);

  if(error){
    // ha hiba, állítsuk vissza
    applyTheme(profile.theme);
    setThemeButtonLabel(themeBtn, profile.theme);
    throw error;
  }

  profile.theme = newTheme;
});













    
  (() => {
    const $ = (id)=>document.getElementById(id);
    const toast = (t)=>{
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=t;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    };

    const DEV_TODAY = '2026-04-16';
    const YEAR = 2026;

    let supabase = null;
    let profile = null;
    let currentUserId = null;

    // ✅ user-specifikus mentett párosok (max 3)
    let quickPairs = []; // [{arrival:'08:00', departure:'16:00'}, ...]
    let quickMode = 'db'; // 'db' | 'local'

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }





function applyTheme(theme){
  const t = (theme === 'light') ? 'light' : 'dark';
  document.documentElement.dataset.theme = t;

  // (opcionális) meta theme-color frissítés
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){
    meta.setAttribute('content', t === 'light' ? '#f3f4f6' : '#27272a');
  }
}

function nextTheme(theme){
  return (theme === 'light') ? 'dark' : 'light';
}

function setThemeButtonLabel(btn, theme){
  btn.textContent = (theme === 'light') ? 'Sötét mód' : 'Világos mód';
}








    
    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }

    function normalizeIsoDate(d){
      return String(d).slice(0,10);
    }

    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const [h,m] = String(hhmm).slice(0,5).split(':').map(Number);
      if(Number.isNaN(h) || Number.isNaN(m)) return null;
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.abs(Math.trunc(Number(mins)||0));
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function noStoreFetch(input, init){
      const o = init ? { ...init } : {};
      o.cache = 'no-store';
      return fetch(input, o);
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' },
        global:{ fetch: noStoreFetch }
      });
      return supabase;
    }

    // ✅ app.html-es wheel logika: gap blank beszúrás
    function buildTimeOptionsWithGap(selectEl, step=15, max=24*60, blankAfterHHMM=null){
      selectEl.innerHTML = '';
      let gapIndex = -1;

      for(let t=0; t<=max; t+=step){
        const h = Math.floor(t/60);
        const mm = t%60;
        const val = `${String(h).padStart(2,'0')}:${String(mm).padStart(2,'0')}`;

        const opt = document.createElement('option');
        opt.value = val;
        opt.textContent = val;
        selectEl.appendChild(opt);

        if(blankAfterHHMM && val === blankAfterHHMM){
          const optGapBlank = document.createElement('option');
          optGapBlank.value = '';
          optGapBlank.textContent = '';
          selectEl.appendChild(optGapBlank);
          gapIndex = selectEl.options.length - 1;
        }
      }

      if(gapIndex < 0){
        const optBlank = document.createElement('option');
        optBlank.value = '';
        optBlank.textContent = '';
        selectEl.insertBefore(optBlank, selectEl.firstChild);
        gapIndex = 0;
      }

      selectEl.dataset.gapBlankIndex = String(gapIndex);
      selectEl.selectedIndex = gapIndex;
    }

    function setSelectToGapBlank(selectEl){
      const idx = Number(selectEl.dataset.gapBlankIndex || 0);
      if(Number.isFinite(idx) && selectEl.options && selectEl.options[idx]){
        selectEl.selectedIndex = idx;
      }else{
        selectEl.value = '';
      }
    }

    function localKey(){
      return `kultora_quickpairs_${currentUserId || 'anon'}`;
    }

    function loadQuickPairsFromLocal(){
      try{
        const raw = localStorage.getItem(localKey());
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      }catch(_){
        return [];
      }
    }

    function saveQuickPairsToLocal(){
      try{
        localStorage.setItem(localKey(), JSON.stringify(quickPairs.slice(0,3)));
      }catch(_){}
    }

    async function loadQuickPairs(){
      quickPairs = loadQuickPairsFromLocal()
        .map(p => ({ arrival:String(p?.arrival||'').slice(0,5), departure:String(p?.departure||'').slice(0,5) }))
        .filter(p => p.arrival && p.departure)
        .slice(0,3);

      if(!currentUserId || !supabase) {
        quickMode = 'local';
        return;
      }

      try{
        const { data, error } = await supabase
          .from('user_quick_pairs')
          .select('id,arrival,departure,created_at')
          .eq('user_id', currentUserId)
          .order('created_at', { ascending:true });

        if(error) throw error;

        const fromDb = (data||[])
          .map(r => ({ arrival:String(r.arrival||'').slice(0,5), departure:String(r.departure||'').slice(0,5), id:r.id }))
          .filter(p => p.arrival && p.departure)
          .slice(0,3);

        if(fromDb.length){
          quickPairs = fromDb.map(p => ({ arrival:p.arrival, departure:p.departure, id:p.id }));
          saveQuickPairsToLocal();
        }

        quickMode = 'db';
      }catch(_e){
        quickMode = 'local';
        $('quickHint').classList.remove('hidden');
        $('quickHint').textContent = 'Gyorsgomb mentés jelenleg csak ezen az eszközön működik (DB tábla hiányzik / nincs hozzáférés).';
      }
    }

    async function syncQuickPairsToDb(){
      if(quickMode !== 'db') return;
      if(!currentUserId) return;

      const payload = quickPairs.slice(0,3).map(p => ({
        user_id: currentUserId,
        arrival: String(p.arrival||'').slice(0,5),
        departure: String(p.departure||'').slice(0,5),
      }));

      const { error: delErr } = await supabase
        .from('user_quick_pairs')
        .delete()
        .eq('user_id', currentUserId);
      if(delErr) throw delErr;

      if(payload.length){
        const { error: insErr } = await supabase
          .from('user_quick_pairs')
          .insert(payload);
        if(insErr) throw insErr;
      }
    }

    function dayClassFromCalendar(row){
      const iso = row.date;
      const isHoliday = (!row.is_workday && !!row.holiday_name);
      if(isHoliday) return 'holiday';
      if(!!row.special_workday) return 'workSaturday';
      if(isWeekendISO(iso)) return 'weekend';
      if(!row.is_workday) return 'rest';
      return '';
    }

    function renderYearCalendar(calendarMap, vacSet, sickSet, missingSet){
      const wrap = $('monthsWrap');
      wrap.innerHTML = '';

      const todayIso = getTodayISO();

      for(let month=1; month<=12; month++){
        const monthCard = document.createElement('div');
        monthCard.className = 'monthCard';

        const mn = document.createElement('div');
        mn.className = 'monthName';
        mn.textContent = huMonthName(month);
        monthCard.appendChild(mn);

        const mdow = document.createElement('div');
        mdow.className = 'miniDow';
        ['H','K','SZ','CS','P','SZO','V'].forEach(x=>{
          const d = document.createElement('div');
          d.textContent = x;
          mdow.appendChild(d);
        });
        monthCard.appendChild(mdow);

        const mg = document.createElement('div');
        mg.className = 'miniGrid';

        const firstIso = `${YEAR}-${String(month).padStart(2,'0')}-01`;
        const firstDate = new Date(firstIso+'T12:00:00');
        let wd = firstDate.getDay();
        wd = wd===0 ? 7 : wd;
        const offset = wd-1;

        const lastDay = new Date(YEAR, month, 0, 12, 0, 0);
        const daysInMonth = lastDay.getDate();

        for(let i=0;i<42;i++){
          const tile = document.createElement('div');
          tile.className = 'dTile';

          const span = document.createElement('span');
          tile.appendChild(span);

          const dayNum = i - offset + 1;
          if(dayNum < 1 || dayNum > daysInMonth){
            tile.classList.add('empty');
            mg.appendChild(tile);
            continue;
          }

          const iso = `${YEAR}-${String(month).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
          span.textContent = String(dayNum);

          const calRow = calendarMap.get(iso);
          if(calRow){
            const cls = dayClassFromCalendar(calRow);
            if(cls) tile.classList.add(cls);
          }else{
            tile.classList.add('rest');
          }

          if(vacSet.has(iso)){
            tile.classList.remove('holiday','weekend','rest','workSaturday','sick');
            tile.classList.add('vac');
          }

          if(sickSet && sickSet.has(iso)){
            tile.classList.remove('holiday','weekend','rest','workSaturday','vac');
            tile.classList.add('sick');
          }

          if(missingSet && missingSet.has(iso)){
            tile.classList.add('missing');
          }

          if(iso === todayIso){
            tile.classList.add('today');
          }

          mg.appendChild(tile);
        }

        monthCard.appendChild(mg);

        monthCard.addEventListener('click', ()=>{
          location.href = `/app.html?y=${YEAR}&m=${month}&v=${Date.now()}`;
        });

        wrap.appendChild(monthCard);
      }
    }

    function formatBalanceLine(balanceMinutes){
      const dayMins = Math.max(1, Number(profile?.daily_expected_minutes || 480));
      const abs = Math.abs(balanceMinutes);

      const hhmm = minsToHHMM(abs);
      const days = Math.floor(abs / dayMins);

      const isPos = balanceMinutes >= 0;
      const label = isPos ? 'túlórád' : 'hátralékod';

      if(days >= 1){
        return `A mai napig <span class="num">${hhmm}</span> óra ${label} van, ez kb <span class="num">${days}</span> napnak felel meg.`;
      }
      return `A mai napig <span class="num">${hhmm}</span> óra ${label} van.`;
    }

    function renderMissingMessage(missingCount){
      const box = $('missingBox');
      const titleEl = $('missingTitle');

      if(!missingCount || missingCount <= 0){
        box.classList.add('hidden');
        titleEl.textContent = '';
        return;
      }

      box.classList.remove('hidden');
      titleEl.innerHTML = `A <span class="inlineLegendSquare" aria-hidden="true"></span>-el jelölt napokon nincs rögzítésed, kérlek pótold!`;
    }

    // ====== ✅ Gyorsgomb logika ======
    function isValidQuickPair(arrival, departure){
      if(!arrival || !departure) return false;
      const a = hhmmToMins(arrival);
      const d = hhmmToMins(departure);
      if(a == null || d == null) return false;
      return a <= d;
    }

    function updateQuickAddBtn(){
      const btn = $('quickAddBtn');
      const a = $('quickArrSel').value || '';
      const d = $('quickDepSel').value || '';
      const valid = isValidQuickPair(a, d);
      const hasRoom = (quickPairs.length < 3);
      btn.classList.toggle('hidden', !(valid && hasRoom));
    }

    function renderQuickPairs(){
      const host = $('quickList');
      host.innerHTML = '';

      if(!quickPairs.length){
        return;
      }

      quickPairs.slice(0,3).forEach((p, idx)=>{
        const item = document.createElement('div');
        item.className = 'quickItem';

        const left = document.createElement('div');
        left.className = 'quickItemText';
        left.textContent = `${String(p.arrival).slice(0,5)} – ${String(p.departure).slice(0,5)}`;

        const del = document.createElement('button');
        del.className = 'quickDelete';
        del.type = 'button';
        del.textContent = 'Törlés';
        del.addEventListener('click', async ()=>{
          try{
            quickPairs.splice(idx, 1);
            saveQuickPairsToLocal();
            if(quickMode === 'db') await syncQuickPairsToDb();
            renderQuickPairs();
            updateQuickAddBtn();
            toast('Törölve');
          }catch(e){
            toast(e?.message || String(e));
          }
        });

        item.appendChild(left);
        item.appendChild(del);
        host.appendChild(item);
      });
    }

    async function addQuickPair(){
      const a = $('quickArrSel').value || '';
      const d = $('quickDepSel').value || '';

      if(quickPairs.length >= 3){
        toast('Legfeljebb 3 gyorsgomb lehet.');
        return;
      }
      if(!isValidQuickPair(a, d)){
        toast('Hiba: Távozás nem lehet korábbi, mint Érkezés!');
        return;
      }

      try{
        quickPairs.push({ arrival:a, departure:d });
        quickPairs = quickPairs.slice(0,3);

        saveQuickPairsToLocal();
        if(quickMode === 'db') await syncQuickPairsToDb();

        setSelectToGapBlank($('quickArrSel'));
        setSelectToGapBlank($('quickDepSel'));

        renderQuickPairs();
        updateQuickAddBtn();
        toast('Hozzáadva');
      }catch(e){
        toast(e?.message || String(e));
      }
    }

    async function loadProfile(){
      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      currentUserId = uid;
      if(!uid) return null;

      // ✅ quick_pairs oszlop NINCS -> nem kérjük le
      const { data, error } = await supabase
        .from('profiles')
        .select('display_name,email,role,daily_expected_minutes,vacation_entitlement_days,vacation_carryover_days,flex_carryover_minutes,flex_bonus_minutes')
        .eq('user_id', uid)
        .maybeSingle();

      if(error) throw error;

      profile = data || {
        display_name: u.user.email,
        email: u.user.email,
        role:'user',
        daily_expected_minutes:480,
        vacation_entitlement_days:0,
        vacation_carryover_days:0,
        flex_carryover_minutes:0,
        flex_bonus_minutes:0
      };

      $('userName').textContent = profile.display_name || profile.email || '';

      const role = String(profile.role || 'user');
      if(role === 'admin' || role === 'manager'){
        $('settingsBtn').classList.remove('hidden');
      }else{
        $('settingsBtn').classList.add('hidden');
      }

      $('quickHint').classList.add('hidden');
      $('quickHint').textContent = '';

      await loadQuickPairs();
      renderQuickPairs();
      updateQuickAddBtn();
    }

    async function loadYearDataAndCompute(){
      const today = getTodayISO();
      const start = `${YEAR}-01-01`;
      const end = `${YEAR+1}-01-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', YEAR)
        .order('date', { ascending:true });
      if(e1) throw e1;

      const calendarMap = new Map();
      (days||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        calendarMap.set(iso, { ...r, date: iso });
      });

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('date,arrival,departure,flex_minutes,is_vacation,is_sick,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end);
      if(e2) throw e2;

      const entriesMap = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        entriesMap.set(iso, { ...r, date: iso });
      });

      const expPerDay = Number(profile?.daily_expected_minutes || 480);
      const carry = Number(profile?.flex_carryover_minutes || 0);
      const bonus = Number(profile?.flex_bonus_minutes || 0);

      let expectedTotal = 0;
      let fulfilledTotal = 0;

      const missingIso = [];

      // Szabi:
      // X: ebben az évben még lehetsz szabin (vacTotal - vacTakenToToday)
      // Y: még beírható (vacTotal - vacRecordedAll)
      // Q: összes beírt szabi az évben (jövő is) -> vacRecordedAll
      // Z: maig kivett -> vacTakenToToday
      let vacTakenToToday = 0;   // Z
      let vacRecordedAll = 0;    // Q

      let sickDaysFullYear = 0;
      const vacSet = new Set();
      const sickSet = new Set();

      const sortedDays = Array.from(calendarMap.values()).sort((a,b)=>a.date.localeCompare(b.date));
      for(const cal of sortedDays){
        const iso = cal.date;

        const entry = entriesMap.get(iso);

        // hiány (csak múlt/ma napokra)
        if(iso <= today){
          const isToday = (iso === today);
          const meaningfulToday =
            !!(entry && (
              (entry.arrival && entry.departure) ||
              (Number(entry.flex_minutes||0) > 0) ||
              !!entry.is_vacation ||
              !!entry.is_sick
            ));
          if(!(isToday && !meaningfulToday)){
            const isWorkday = !!cal.is_workday;
            const isSpecial = !!cal.special_workday;
            if((isWorkday || isSpecial) && !entry){
              missingIso.push(iso);
            }
          }
        }

        // túlóra/hátralék számolás (csak maig)
        if(iso > today) continue;

        const isWorkday = !!cal.is_workday;
        const isSpecial = !!cal.special_workday;

        const expected = isWorkday ? expPerDay : 0;
        expectedTotal += expected;

        let fulfilled = 0;

        if(entry){
          const vac = !!entry.is_vacation;
          const sick = !!entry.is_sick;

          if((vac || sick) && isWorkday){
            fulfilled += expected;
          }

          let worked = 0;
          if(entry.arrival && entry.departure){
            const inM = hhmmToMins(entry.arrival);
            const outM = hhmmToMins(entry.departure);
            if(inM != null && outM != null && outM >= inM){
              worked = outM - inM;
            }
          }
          const flexM = Math.max(0, Number(entry.flex_minutes || 0));
          worked = Math.max(0, worked - flexM);

          const isWeekendOrHolidayDouble = (!isWorkday && !isSpecial);
          let mult = 1;
          if(isWeekendOrHolidayDouble) mult = 2;
          if(vac && worked > 0) mult = 2;

          fulfilled += (worked * mult);
        }

        fulfilledTotal += fulfilled;
      }

      const balance = (carry + bonus) + (fulfilledTotal - expectedTotal);
      $('sumFlex').innerHTML = formatBalanceLine(balance);

      // év összes bejegyzése: vac/sick számlálás + jelölés
      for(const [iso, entry] of entriesMap.entries()){
        const cal = calendarMap.get(iso);
        const isWorkday = !!(cal && cal.is_workday);

        if(entry?.is_vacation && isWorkday){
          vacRecordedAll++;     // Q
          vacSet.add(iso);
          if(iso <= today) vacTakenToToday++; // Z
        }

        if(entry?.is_sick && isWorkday){
          sickDaysFullYear++;
          sickSet.add(iso);
        }
      }

      const vacEnt = Number(profile?.vacation_entitlement_days || 0);
      const vacCarry = Number(profile?.vacation_carryover_days || 0);
      const E = vacEnt + vacCarry;

      const X = Math.max(0, E - vacTakenToToday);
      const Y = Math.max(0, E - vacRecordedAll);
      const Q = Math.max(0, vacRecordedAll);

      // ✅ ÚJ szövegezés (3 sor)
      const lines = [];
      lines.push(`Az éves szabi kereted <span class="num">${E}</span> nap.`);
      lines.push(`Ebben az évben még <span class="num">${X}</span> napot lehetsz szabin.`);
      lines.push(`Már beírtál a naptárba <span class="num">${Q}</span> nap szabadságot, még beírhatsz <span class="num">${Y}</span> napot.`);
      $('sumVac').innerHTML = lines.join('<br><br>');

      const sickEl = $('sumSick');
      if(sickDaysFullYear > 0){
        sickEl.classList.remove('hidden');
        sickEl.innerHTML = `<span class="num">${sickDaysFullYear}</span> napot voltál betegállományban.`;
      }else{
        sickEl.classList.add('hidden');
        sickEl.innerHTML = '';
      }

      renderMissingMessage(missingIso.length);

      const missingSet = new Set(missingIso);
      renderYearCalendar(calendarMap, vacSet, sickSet, missingSet);
    }

    let refreshing = false;
    async function refresh(){
      if(refreshing) return;
      refreshing = true;
      try{
        await ensureSupabase();

        const { data } = await supabase.auth.getSession();
        if(!data.session){
          location.replace('/index.html?v=' + Date.now());
          return;
        }

        await loadProfile();
        await loadYearDataAndCompute();
      }finally{
        refreshing = false;
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      // ✅ wheel-ek: ugyanaz a mechanika mint app.html-ben
      buildTimeOptionsWithGap($('quickArrSel'), 15, 24*60, '08:00');
      buildTimeOptionsWithGap($('quickDepSel'), 15, 24*60, '16:00');

      $('logoutBtn').addEventListener('click', async ()=>{
        try{
          await ensureSupabase();
          await supabase.auth.signOut();
        }catch(_){}
        location.replace('/index.html?v=' + Date.now());
      });

      $('calendarBtn').addEventListener('click', ()=>{
        location.href = '/app.html?v=' + Date.now();
      });

      $('settingsBtn').addEventListener('click', ()=>{
        location.href = '/manager.html?v=' + Date.now();
      });

      $('quickArrSel').addEventListener('change', updateQuickAddBtn);
      $('quickDepSel').addEventListener('change', updateQuickAddBtn);
      $('quickAddBtn').addEventListener('click', addQuickPair);

      refresh().catch(e=>toast('Indulási hiba: ' + (e?.message||String(e))));

      window.addEventListener('pageshow', ()=>{ refresh().catch(()=>{}); });
      window.addEventListener('focus', ()=>{ refresh().catch(()=>{}); });
      document.addEventListener('visibilitychange', ()=>{
        if(!document.hidden) refresh().catch(()=>{});
      });
    });
  })();
  </script>
</body>
</html>
