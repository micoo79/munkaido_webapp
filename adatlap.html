<!-- adatlap.html (Összesítő) -->
<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Összesítő</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#27272a;
      --panel:#27272a;
      --text:#f2f3f5;
      --muted:#c9cbd1;
      --accent:#ff8a00;

      --rest:#3f3f46;
      --holiday:#f6b2b2;
      --vac:#b9d9ff;
      --work:#ffffff;
      --weekend:#777b81;

      --zold:#1ecb5b;
      --piros:#ff3b30;

      --day:16px;
      --dayGap:1px;
      --monthGap:3px;
      --dayFont:11px;
      --maxCols:6;
      --monthPad:8px;

      --monthGridW: calc(7 * var(--day) + 6 * var(--dayGap));
      --monthCardW: calc(var(--monthGridW) + 2 * var(--monthPad));
    }

    *{box-sizing:border-box;}
    html,body{height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

    /* ----- HEADER ----- */
    .header{
      max-width:900px;
      margin:0 auto;
      padding:0 12px;
      height:52px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:transparent;
    }
    .user-block{display:flex; align-items:center; gap:6px; min-width:0;}
    .user-name{
      font-weight:700; font-size:16px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
      max-width:48vw;
    }
    .nav-container{display:flex; gap:0; align-items:center;}
    .nav-item{
      border:0; background:transparent; color:var(--text);
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      width:44px; height:52px; position:relative; cursor:pointer;
      -webkit-tap-highlight-color:transparent; padding:0;
    }
    .material-symbols-outlined{
      font-size:24px;
      font-variation-settings:'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      transition:color .2s ease; line-height:1;
    }
    .menu-label{
      font-size:10px; position:absolute; bottom:4px; left:50%;
      transform:translateX(-50%); white-space:nowrap; pointer-events:none;
      transition:opacity .2s ease, color .2s ease;
    }

    /* Kilépés: ikon fehér, felirat fehér (kérés) */
    .logout-item .material-symbols-outlined{ color:var(--text); opacity:1; }
    .logout-item .menu-label{ color:var(--text); opacity:1; }

    /* Rögzítés: felirat alapból látszik, hoverre narancs */
    .rec-item .menu-label{opacity:1; color:var(--text);}
    .rec-item:hover .material-symbols-outlined,
    .rec-item:hover .menu-label{color:var(--accent);}

    /* Összesítő ikon/szöveg ne látszódjon itt */
    .sum-item{display:none !important;}

    /* Beállítások: hover label */
    .settings-item .menu-label{opacity:0;}
    .settings-item:hover .material-symbols-outlined,
    .settings-item:hover .menu-label{ opacity:1; color:var(--accent); }

    .hidden{display:none !important;}

    /* ----- CONTENT ----- */
    .wrap{max-width:900px; margin:0 auto; padding:0 12px 18px;}
    .card{background:var(--panel); border:0; border-radius:16px; padding:10px;}

    .summaryBox{
      display:flex; flex-direction:column; gap:8px;
      padding:10px 10px 12px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
      margin-bottom:10px;
    }

    /* A túlóra/hátralék sor: mindig tördelhető, mindig látszik */
    .summaryLine{
      font-size:14px; line-height:1.25; color:var(--text);
      white-space:normal; overflow:visible; text-overflow:clip;
      word-break:break-word;
    }
    /* kiemelt számok: fehér (kérés) */
    .summaryLine .num{font-size:115%; font-weight:800; color:var(--text) !important;}

    .missingBox{
      margin-top:6px;
      padding:10px;
      border-radius:14px;
      background:rgba(255,255,255,.06);
    }
    .missingTitle{
      font-size:12px;
      font-weight:800;
      margin-bottom:6px;
      color:var(--text);
    }
    .missingList{
      font-size:12px;
      line-height:1.2;
      color:var(--text);
      user-select:text;
    }
    .missDate{
      color:var(--text);
      text-decoration:underline;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }
    .missDate.old{ color:var(--piros); }

    .yearTitle{
      font-weight:800;
      font-size:1rem;
      margin:10px 0 8px;
      text-align:center;
    }

    .monthsWrap{
      display:flex;
      flex-wrap:wrap;
      gap:var(--monthGap);
      justify-content:center;
      align-items:flex-start;
    }

    .monthCard{
      width:var(--monthCardW);
      flex: 0 0 var(--monthCardW);
      background:rgba(255,255,255,.06);
      border-radius:10px;
      padding:var(--monthPad);
      overflow:hidden;
      cursor:pointer;
      -webkit-tap-highlight-color:transparent;
    }

    .monthName{
      font-size:0.8rem;
      font-weight:800;
      text-align:center;
      margin:0 0 4px 0;
      line-height:1.1;
    }

    .miniDow{
      display:grid;
      grid-template-columns:repeat(7,var(--day));
      gap:var(--dayGap);
      margin-bottom:var(--dayGap);
      opacity:.9;
      justify-content:center;
    }
    .miniDow div{
      width:var(--day);
      height:12px;
      display:flex; align-items:center; justify-content:center;
      font-size:9px; font-weight:700; color:var(--muted);
      line-height:1;
    }

    .miniGrid{
      display:grid;
      grid-template-columns:repeat(7,var(--day));
      grid-template-rows:repeat(6,var(--day));
      gap:var(--dayGap);
      justify-content:center;
    }

    .dTile{
      width:var(--day);
      height:var(--day);
      border:0;
      border-radius:0;
      background:var(--work);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0;
      user-select:none;
      overflow:hidden;
    }
    .dTile span{
      font-size:var(--dayFont);
      font-weight:700;
      line-height:1;
      color:#111;
      transform: translateY(0.5px);
    }

    .dTile.rest{background:var(--rest); opacity:1;}
    .dTile.weekend{background:var(--weekend);}
    .dTile.holiday{background:var(--holiday);}
    .dTile.vac{background:var(--vac);}
    .dTile.workSaturday{background:var(--work);}

    .dTile.empty{background:transparent; border:0;}
    .dTile.empty span{display:none;}

    .dTile.today{
      outline:2px solid var(--accent);
      outline-offset:-2px;
    }

    .dTile.weekend span{color:#fff;}
    .dTile.rest span{color:#9ca3af;}

    /* Toast */
    .toast{
      position:fixed; left:12px; right:12px; bottom:12px;
      background:var(--accent); color:#111;
      padding:14px; border-radius:14px;
      font-size:18px;
      z-index:99;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="user-block">
      <div id="userName" class="user-name"></div>
      <button id="logoutBtn" class="nav-item logout-item" type="button" aria-label="Kilépés">
        <span class="material-symbols-outlined">logout</span>
        <span class="menu-label">Kilépés</span>
      </button>
    </div>

    <nav class="nav-container">
      <button id="calendarBtn" class="nav-item rec-item" type="button" aria-label="Rögzítés">
        <span class="material-symbols-outlined">edit_calendar</span>
        <span class="menu-label">Rögzítés</span>
      </button>

      <button id="sumBtn" class="nav-item sum-item" type="button" aria-label="Összesítő">
        <span class="material-symbols-outlined">overview</span>
        <span class="menu-label">Összesítő</span>
      </button>

      <button id="settingsBtn" class="nav-item settings-item hidden" type="button" aria-label="Beállítások">
        <span class="material-symbols-outlined">settings</span>
        <span class="menu-label">Beállítások</span>
      </button>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="summaryBox">
        <div id="sumFlex" class="summaryLine">Betöltés…</div>
        <div id="sumVac"  class="summaryLine">Betöltés…</div>
      </div>

      <div class="missingBox">
        <div class="missingTitle">Az alábbi napokon nem rögzítettél munkaidőt:</div>
        <div id="missingList" class="missingList">Betöltés…</div>
      </div>

      <div class="yearTitle" id="yearTitle">2026 – Éves naptár</div>
      <div id="monthsWrap" class="monthsWrap"></div>
    </section>
  </main>

  <script>
  (() => {
    const $ = (id)=>document.getElementById(id);
    const toast = (t)=>{
      const el = document.createElement('div');
      el.className='toast';
      el.textContent=t;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 2200);
    };

    const DEV_TODAY = '2026-04-16';
    const YEAR = 2026;

    let supabase = null;
    let profile = null;

    function getTodayISO(){
      if(DEV_TODAY) return DEV_TODAY;
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const day = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    function huMonthName(m){
      const names = ['Január','Február','Március','Április','Május','Június','Július','Augusztus','Szeptember','Október','November','December'];
      return names[m-1] || '';
    }

    function normalizeIsoDate(d){
      return String(d).slice(0,10);
    }

    function isWeekendISO(iso){
      const d = new Date(iso+'T12:00:00');
      const wd = d.getDay();
      return wd===0 || wd===6;
    }

    function hhmmToMins(hhmm){
      if(!hhmm) return null;
      const [h,m] = String(hhmm).slice(0,5).split(':').map(Number);
      return h*60 + m;
    }

    function minsToHHMM(mins){
      const m = Math.abs(Math.trunc(Number(mins)||0));
      const h = Math.floor(m/60);
      const mm = m%60;
      return `${String(h).padStart(1,'0')}:${String(mm).padStart(2,'0')}`;
    }

    function addDaysISO(iso, days){
      const d = new Date(iso + 'T12:00:00');
      d.setDate(d.getDate() + days);
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }

    function daysBetween(aIso, bIso){
      const a = new Date(aIso + 'T12:00:00');
      const b = new Date(bIso + 'T12:00:00');
      return Math.round((b - a) / (24*60*60*1000));
    }

    async function ensureSupabase(){
      if(supabase) return supabase;

      const t0=Date.now();
      while(!(window.supabase && window.supabase.createClient)){
        if(Date.now()-t0>6000) throw new Error('Supabase CDN nem töltődött be.');
        await new Promise(r=>setTimeout(r,120));
      }

      const r = await fetch('/config', { cache:'no-store' });
      if(!r.ok) throw new Error('Nem elérhető a /config.');
      const j = await r.json();
      const url = j.SUPABASE_URL || j.supabaseUrl;
      const key = j.SUPABASE_ANON_KEY || j.supabaseAnonKey;
      if(!url || !key) throw new Error('Hiányzó Supabase URL / ANON key (/config).');

      supabase = window.supabase.createClient(url, key, {
        auth:{ persistSession:true, autoRefreshToken:true, detectSessionInUrl:true },
        db:{ schema:'app' }
      });
      return supabase;
    }

    async function loadProfile(){
      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;
      if(!uid) return null;

      const { data, error } = await supabase
        .from('profiles')
        .select('display_name,email,role,daily_expected_minutes,vacation_entitlement_days,vacation_carryover_days,flex_carryover_minutes,flex_bonus_minutes')
        .eq('user_id', uid)
        .maybeSingle();

      if(error) throw error;

      profile = data || {
        display_name: u.user.email,
        email: u.user.email,
        role:'user',
        daily_expected_minutes:480,
        vacation_entitlement_days:0,
        vacation_carryover_days:0,
        flex_carryover_minutes:0,
        flex_bonus_minutes:0
      };

      $('userName').textContent = profile.display_name || profile.email || '';

      const role = String(profile.role || 'user');
      if(role === 'admin' || role === 'manager'){
        $('settingsBtn').classList.remove('hidden');
      }else{
        $('settingsBtn').classList.add('hidden');
      }
    }

    function dayClassFromCalendar(row){
      const iso = row.date;
      const isHoliday = (!row.is_workday && !!row.holiday_name);
      if(isHoliday) return 'holiday';
      if(!!row.special_workday) return 'workSaturday';
      if(isWeekendISO(iso)) return 'weekend';
      if(!row.is_workday) return 'rest';
      return '';
    }

    function renderYearCalendar(calendarMap, vacSet){
      const wrap = $('monthsWrap');
      wrap.innerHTML = '';

      const todayIso = getTodayISO();

      for(let month=1; month<=12; month++){
        const monthCard = document.createElement('div');
        monthCard.className = 'monthCard';

        const mn = document.createElement('div');
        mn.className = 'monthName';
        mn.textContent = huMonthName(month);
        monthCard.appendChild(mn);

        const mdow = document.createElement('div');
        mdow.className = 'miniDow';
        ['H','K','SZ','CS','P','SZO','V'].forEach(x=>{
          const d = document.createElement('div');
          d.textContent = x;
          mdow.appendChild(d);
        });
        monthCard.appendChild(mdow);

        const mg = document.createElement('div');
        mg.className = 'miniGrid';

        const firstIso = `${YEAR}-${String(month).padStart(2,'0')}-01`;
        const firstDate = new Date(firstIso+'T12:00:00');
        let wd = firstDate.getDay();
        wd = wd===0 ? 7 : wd;
        const offset = wd-1;

        const lastDay = new Date(YEAR, month, 0, 12, 0, 0);
        const daysInMonth = lastDay.getDate();

        for(let i=0;i<42;i++){
          const tile = document.createElement('div');
          tile.className = 'dTile';

          const span = document.createElement('span');
          tile.appendChild(span);

          const dayNum = i - offset + 1;
          if(dayNum < 1 || dayNum > daysInMonth){
            tile.classList.add('empty');
            mg.appendChild(tile);
            continue;
          }

          const iso = `${YEAR}-${String(month).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
          span.textContent = String(dayNum);

          const calRow = calendarMap.get(iso);
          if(calRow){
            const cls = dayClassFromCalendar(calRow);
            if(cls) tile.classList.add(cls);
          }else{
            tile.classList.add('rest');
          }

          if(vacSet.has(iso)){
            tile.classList.remove('holiday','weekend','rest','workSaturday');
            tile.classList.add('vac');
          }

          if(iso === todayIso){
            tile.classList.add('today');
          }

          mg.appendChild(tile);
        }

        monthCard.appendChild(mg);

        monthCard.addEventListener('click', ()=>{
          location.href = `/app.html?y=${YEAR}&m=${month}&v=${Date.now()}`;
        });

        wrap.appendChild(monthCard);
      }
    }

    function formatBalanceLine(balanceMinutes){
      const dayMins = Math.max(1, Number(profile?.daily_expected_minutes || 480));
      const abs = Math.abs(balanceMinutes);

      const hhmm = minsToHHMM(abs);
      const days = Math.floor(abs / dayMins);

      const isPos = balanceMinutes >= 0;
      const label = isPos ? 'túlórád' : 'hátralékod';

      if(days >= 1){
        return `A mai napig <span class="num">${hhmm}</span> óra ${label} van,<br>ez kb <span class="num">${days}</span> napnak felel meg.`;
      }
      return `A mai napig <span class="num">${hhmm}</span> óra ${label} van.`;
    }

    function renderMissingDates(missingIsoList, todayIso){
      const box = $('missingList');
      box.innerHTML = '';

      if(missingIsoList.length === 0){
        box.textContent = 'Nincs hiányzó rögzítés.';
        return;
      }

      // 2 hétnél régebbi => piros
      // (ma - dátum > 14)
      missingIsoList.forEach((iso, idx)=>{
        const a = document.createElement('span');
        a.className = 'missDate';

        const age = daysBetween(iso, todayIso);
        if(age > 14) a.classList.add('old');

        a.textContent = iso.replaceAll('-', '.');

        a.addEventListener('click', ()=>{
          const y = Number(iso.slice(0,4));
          const m = Number(iso.slice(5,7));
          location.href = `/app.html?y=${y}&m=${m}&v=${Date.now()}`;
        });

        box.appendChild(a);

        if(idx < missingIsoList.length - 1){
          box.appendChild(document.createTextNode(', '));
        }
      });
    }

    async function loadYearDataAndCompute(){
      const today = getTodayISO();
      const start = `${YEAR}-01-01`;
      const end = `${YEAR+1}-01-01`;

      const { data: days, error: e1 } = await supabase
        .from('calendar_days')
        .select('date,is_workday,holiday_name,special_workday,year')
        .eq('year', YEAR)
        .order('date', { ascending:true });
      if(e1) throw e1;

      const calendarMap = new Map();
      (days||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        calendarMap.set(iso, { ...r, date: iso });
      });

      const { data: u } = await supabase.auth.getUser();
      const uid = u?.user?.id;

      const { data: ents, error: e2 } = await supabase
        .from('entries')
        .select('date,arrival,departure,flex_minutes,is_vacation,note')
        .eq('user_id', uid)
        .gte('date', start)
        .lt('date', end);
      if(e2) throw e2;

      const entriesMap = new Map();
      (ents||[]).forEach(r=>{
        const iso = normalizeIsoDate(r.date);
        entriesMap.set(iso, { ...r, date: iso });
      });

      const expPerDay = Number(profile?.daily_expected_minutes || 480);
      const carry = Number(profile?.flex_carryover_minutes || 0);
      const bonus = Number(profile?.flex_bonus_minutes || 0);

      let expectedTotal = 0;
      let fulfilledTotal = 0;

      let takenVacationDays = 0;
      const vacSet = new Set();

      const missingIso = [];

      // napok today-ig
      const sortedDays = Array.from(calendarMap.values()).sort((a,b)=>a.date.localeCompare(b.date));
      for(const cal of sortedDays){
        const iso = cal.date;
        if(iso > today) break;

        const entry = entriesMap.get(iso);

        // ma csak akkor számít, ha van "érdemi" rögzítés (arrival+departure vagy flex>0 vagy szabi)
        const isToday = (iso === today);
        const meaningfulToday =
          !!(entry && (
            (entry.arrival && entry.departure) ||
            (Number(entry.flex_minutes||0) > 0) ||
            !!entry.is_vacation
          ));
        if(isToday && !meaningfulToday){
          continue;
        }

        const isWorkday = !!cal.is_workday;
        const isSpecial = !!cal.special_workday;

        // hiányzó lista: munkanap vagy szombati munkanap,
        // és semmilyen rögzítés nincs rá (szabi sem)
        if((isWorkday || isSpecial) && !entry){
          missingIso.push(iso);
        }

        const expected = isWorkday ? expPerDay : 0;
        expectedTotal += expected;

        let fulfilled = 0;

        if(entry){
          const vac = !!entry.is_vacation;
          if(vac && isWorkday){
            fulfilled += expected;
            takenVacationDays++;
            vacSet.add(iso);
          }

          let worked = 0;
          if(entry.arrival && entry.departure){
            const inM = hhmmToMins(entry.arrival);
            const outM = hhmmToMins(entry.departure);
            if(inM != null && outM != null && outM >= inM){
              worked = outM - inM;
            }
          }
          const flexM = Math.max(0, Number(entry.flex_minutes || 0));
          worked = Math.max(0, worked - flexM);

          // dupláz: hétvége/ünnepnap (nem munkanap és nem special_workday) vagy szabi alatti munka
          const isWeekendOrHolidayDouble = (!isWorkday && !isSpecial);
          let mult = 1;
          if(isWeekendOrHolidayDouble) mult = 2;
          if(vac && worked > 0) mult = 2;

          fulfilled += (worked * mult);
        }

        fulfilledTotal += fulfilled;
      }

      const balance = (carry + bonus) + (fulfilledTotal - expectedTotal);
      $('sumFlex').innerHTML = formatBalanceLine(balance);

      const vacEnt = Number(profile?.vacation_entitlement_days || 0);
      const vacCarry = Number(profile?.vacation_carryover_days || 0);
      const vacTotal = vacEnt + vacCarry;
      const vacRemaining = vacTotal - takenVacationDays;

      if(vacRemaining <= 0){
        $('sumVac').innerHTML = `Nincs több szabid.`;
      }else{
        $('sumVac').innerHTML = `Még <span class="num">${vacRemaining}</span> nap szabid van.`;
      }

      renderMissingDates(missingIso, today);
      renderYearCalendar(calendarMap, vacSet);
    }

    async function boot(){
      await ensureSupabase();

      const { data } = await supabase.auth.getSession();
      if(!data.session){
        location.replace('/index.html?v=' + Date.now());
        return;
      }

      $('yearTitle').textContent = `${YEAR} – Éves naptár`;

      await loadProfile();
      await loadYearDataAndCompute();
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      $('logoutBtn').addEventListener('click', async ()=>{
        try{
          await ensureSupabase();
          await supabase.auth.signOut();
        }catch(_){}
        location.replace('/index.html?v=' + Date.now());
      });

      $('calendarBtn').addEventListener('click', ()=>{
        location.href = '/app.html?v=' + Date.now();
      });

      $('settingsBtn').addEventListener('click', ()=>{
        location.href = '/manager.html?v=' + Date.now();
      });

      boot().catch(e=>toast('Indulási hiba: ' + (e?.message||String(e))));
    });
  })();
  </script>
</body>
</html>
